<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teacher Portal â€“ Discovery Room Booking</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#fefce8',
              100: '#fef9c3',
              200: '#fef08a',
              300: '#fde047',
              400: '#facc15',
              500: '#eab308',
              600: '#ca8a04',
              700: '#a16207',
              800: '#854d0e',
              900: '#713f12',
            },
            secondary: {
              50: '#faf5ff',
              100: '#f3e8ff',
              200: '#e9d5ff',
              300: '#d8b4fe',
              400: '#c084fc',
              500: '#a855f7',
              600: '#9333ea',
              700: '#7e22ce',
              800: '#6b21a8',
              900: '#581c87',
            },
            accent: {
              50: '#fff1f1',
              100: '#ffe1e1',
              200: '#ffc7c7',
              300: '#ff9d9d',
              400: '#ff6b6b',
              500: '#f43f5e',
              600: '#e11d48',
              700: '#be123c',
              800: '#9f1239',
              900: '#881337',
            },
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
    }
    .card {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }
    .btn-primary {
      background-image: linear-gradient(to right, #eab308, #ca8a04);
    }
    .btn-primary:hover {
      background-image: linear-gradient(to right, #ca8a04, #a16207);
    }
    .btn-secondary {
      background-image: linear-gradient(to right, #a855f7, #9333ea);
    }
    .btn-secondary:hover {
      background-image: linear-gradient(to right, #9333ea, #7e22ce);
    }
    .btn-accent {
      background-image: linear-gradient(to right, #f43f5e, #e11d48);
    }
    .btn-accent:hover {
      background-image: linear-gradient(to right, #e11d48, #be123c);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-primary-50 to-primary-200 min-h-screen">
  <!-- Home/Back Button Top Right -->
  <div class="absolute top-6 right-6 z-20">
    <button id="homeBtn" title="Back to Booking Page" class="inline-flex items-center px-4 py-2 bg-white text-primary-700 rounded-full shadow-lg border border-primary-200 hover:bg-primary-100 transition-colors duration-200">
      <i class="fas fa-home text-xl"></i>
    </button>
  </div>
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header with logo and title -->
    <header class="mb-8 flex flex-col items-center">
      <div class="w-16 h-16 mb-4 bg-blue-800 rounded-full flex items-center justify-center shadow-md">
        <i class="fas fa-chalkboard-teacher text-yellow-200 text-2xl"></i>
      </div>
      <h1 class="text-3xl font-bold mb-1" style="color: #1e3a8a;">Discovery Room Booking</h1>
      <p class="text-yellow-100">Teacher Portal - Manage your bookings</p>
    </header>

  <!-- ...existing code... -->

    <!-- Portal Section (hidden initially) -->
    <div id="portalSection" class="hidden">
      <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4 bg-white rounded-xl card p-4">
        <div>
          <h2 class="text-xl font-semibold text-secondary-800">My Bookings Dashboard</h2>
          <p class="text-secondary-500 text-sm">Manage your Discovery Room bookings</p>
          <p id="welcomeName" class="text-primary-700 text-lg font-bold mt-2"></p>
        </div>
        <button id="logoutBtn" class="px-4 py-2 btn-secondary text-white rounded-lg font-medium flex items-center gap-2 hover:shadow-md">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </button>
      </div>
      
      <div class="grid gap-6">
        <div id="bookingsTable" class="bg-white rounded-xl card p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-secondary-800">Upcoming Bookings</h3>
            <button id="newBookingBtn" class="px-3 py-1.5 bg-primary-100 text-primary-700 rounded-lg text-sm font-medium hover:bg-primary-200">
              <i class="fas fa-plus mr-1"></i> New Booking
            </button>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-secondary-200">
              <thead class="bg-secondary-50">
                <tr>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Date</th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Time</th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Room</th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Purpose</th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Status</th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-secondary-200">
                <!-- Bookings will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div id="queueTable" class="bg-white rounded-xl card p-6">
          <h3 class="text-lg font-semibold text-secondary-800 mb-4">Waiting List</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-secondary-200">
              <thead class="bg-secondary-50">
                <tr>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Request Date</th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Preferred Date</th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Room</th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Status</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-secondary-200">
                <!-- Queue will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals would go here in a real implementation -->

  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
  <script>
    // Firebase config (same as index.html)
    const firebaseConfig = {
      apiKey:    "AIzaSyBKhgPEWHqW36Xg0Bx6qwsXq9Hnew0094o",
      authDomain:"school-booking-platform.firebaseapp.com",
      projectId: "school-booking-platform",
      storageBucket: "school-booking-platform.appspot.com",
      messagingSenderId:"673281572597",
      appId:     "1:673281572597:web:fe0ceec0054560f6258fbc",
      measurementId:"G-TVQ5PK5WZF"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication and approval from localStorage (set by index.html)
      let user = null;
      try {
        user = JSON.parse(localStorage.getItem('edtechUser'));
      } catch { user = null; }
      if (!user || !user.name || !user.email || !user.role) {
        // Not authenticated, redirect to main page
        window.location.href = 'index.html';
        return;
      }
      // Check approval status from Firestore
      firebase.firestore().collection('users').where('email', '==', user.email).get().then(snap => {
        let userDoc = null;
        snap.forEach(doc => userDoc = doc);
        if (!userDoc || !userDoc.data().approved) {
          // Not approved, redirect to main page
          window.location.href = 'index.html';
          return;
        }
        // Authenticated and approved: show portal
        document.getElementById('portalSection').classList.remove('hidden');
        // Show welcome name
        const welcomeName = document.getElementById('welcomeName');
        if (welcomeName) welcomeName.textContent = `Welcome, ${user.name}!`;
        // Home/Back button logic
        const homeBtn = document.getElementById('homeBtn');
        if (homeBtn) {
          homeBtn.onclick = function() {
            window.location.href = 'index.html';
          };
        }
        // New Booking button logic
        const newBookingBtn = document.getElementById('newBookingBtn');
        if (newBookingBtn) {
          newBookingBtn.onclick = function() {
            window.location.href = 'index.html';
          };
        }
        // Logout button logic
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.onclick = function() {
            window.loggedInTeacherName = '';
            localStorage.removeItem('edtechUser');
            window.location.href = 'index.html';
          };
        }
        // Load teacher bookings and queue from Firestore
        async function loadTeacherBookings(email) {
          // Bookings
          const bookingsTable = document.querySelector('#bookingsTable tbody');
          bookingsTable.innerHTML = '';
          const bookingsSnap = await firebase.firestore().collection('bookings').where('studentEmail', '==', email).get();
          bookingsSnap.forEach(doc => {
            const data = doc.data();
            const tr = document.createElement('tr');
            let statusLabel = '';
            let statusClass = '';
            let disableActions = false;
            if (data.status === 'confirmed') {
              statusLabel = 'Confirmed';
              statusClass = 'bg-green-100 text-green-800';
            } else if (data.status === 'rescheduled') {
              statusLabel = 'Rescheduled';
              statusClass = 'bg-gray-300 text-gray-600';
              disableActions = true;
            } else {
              statusLabel = data.status || 'Pending';
              statusClass = 'bg-yellow-100 text-yellow-800';
            }
            tr.innerHTML = `
              <td class="px-4 py-3 whitespace-nowrap text-sm text-secondary-800">${data.date || ''}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-secondary-800">${data.time || ''}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-secondary-800">${data.room || ''}</td>
              <td class="px-4 py-3 text-sm text-secondary-800">${data.purpose || ''}</td>
              <td class="px-4 py-3 whitespace-nowrap">
                <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${statusLabel}</span>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-secondary-800">
                <button class="text-primary-600 hover:text-primary-800 mr-2 edit-booking-btn" data-id="${doc.id}" ${disableActions ? 'disabled style="opacity:0.5;cursor:not-allowed"' : ''}><i class="fas fa-edit"></i></button>
                <button class="text-accent-600 hover:text-accent-800 cancel-booking-btn" data-id="${doc.id}" ${disableActions ? 'disabled style="opacity:0.5;cursor:not-allowed"' : ''}><i class="fas fa-trash"></i></button>
              </td>
            `;
            bookingsTable.appendChild(tr);
          });
          // Queue (pending bookings)
          const queueTable = document.querySelector('#queueTable tbody');
          queueTable.innerHTML = '';
          const queueSnap = await firebase.firestore().collection('bookings').where('studentEmail', '==', email).where('status', '==', 'pending').get();
          queueSnap.forEach(doc => {
            const data = doc.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="px-4 py-3 whitespace-nowrap text-sm text-secondary-800">${data.createdAt ? new Date(data.createdAt).toLocaleDateString() : ''}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-secondary-800">${data.date || ''}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-secondary-800">${data.room || ''}</td>
              <td class="px-4 py-3 whitespace-nowrap">
                <span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Pending</span>
              </td>
            `;
            queueTable.appendChild(tr);
          });
          // Add edit/cancel listeners
          document.querySelectorAll('.edit-booking-btn').forEach(btn => {
            btn.onclick = function() {
              const bookingId = btn.getAttribute('data-id');
              // Find booking data
              const bookingRow = btn.closest('tr');
              const statusCell = bookingRow.querySelector('td:nth-child(5) span');
              const isConfirmed = statusCell && statusCell.textContent.trim().toLowerCase() === 'confirmed';
              const isRescheduled = statusCell && statusCell.textContent.trim().toLowerCase() === 'rescheduled';
              if (isConfirmed) {
                showConfirmEditModal(bookingId);
              } else if (!isRescheduled) {
                showEditBookingModal(bookingId, email);
              }
            };
          });
          document.querySelectorAll('.cancel-booking-btn').forEach(btn => {
            btn.onclick = async function() {
              const bookingId = btn.getAttribute('data-id');
              const bookingRow = btn.closest('tr');
              const statusCell = bookingRow.querySelector('td:nth-child(5) span');
              const isRescheduled = statusCell && statusCell.textContent.trim().toLowerCase() === 'rescheduled';
              if (!isRescheduled) {
                if (confirm('Are you sure you want to cancel this booking?')) {
                  await firebase.firestore().collection('bookings').doc(bookingId).delete();
                  loadTeacherBookings(email);
                }
              }
            };
          });
        }
        // Modal for confirmed booking: Reschedule or Cancel
        function showConfirmEditModal(bookingId) {
          // Remove any existing modal
          let old = document.getElementById('editBookingModal');
          if (old) old.remove();
          const modal = document.createElement('div');
          modal.id = 'editBookingModal';
          modal.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
          modal.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full fade-in text-center">
              <h2 class="text-xl font-bold text-blue-800 mb-4">Edit Booking</h2>
              <p class="mb-4 text-gray-700">What would you like to do with this confirmed booking?</p>
              <div class="flex flex-col gap-3">
                <button id="rescheduleBtn" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition">Reschedule</button>
                <button id="cancelBookingBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">Cancel Booking</button>
                <button id="closeEditModalBtn" class="mt-2 px-4 py-2 border rounded text-gray-700 hover:bg-gray-100">Close</button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          modal.querySelector('#closeEditModalBtn').onclick = () => modal.remove();
          modal.querySelector('#rescheduleBtn').onclick = async () => {
            // Delete original booking to free the slot
            try {
              await firebase.firestore().collection('bookings').doc(bookingId).delete();
            } catch (err) {
              alert('Failed to reschedule booking.');
              return;
            }
            modal.remove();
            window.location.href = 'index.html';
          };
          modal.querySelector('#cancelBookingBtn').onclick = async () => {
            try {
              await firebase.firestore().collection('bookings').doc(bookingId).delete();
              modal.remove();
              alert('Booking cancelled. The slot is now available for others.');
              loadTeacherBookings(user.email);
            } catch (err) {
              alert('Failed to cancel booking.');
            }
          };
        }
        // Show edit modal for booking (simple prompt for new date)
        function showEditBookingModal(bookingId, email) {
          const newDate = prompt('Enter new booking date (YYYY-MM-DD):');
          if (newDate) {
            firebase.firestore().collection('bookings').doc(bookingId).update({ date: newDate, status: 'pending' })
              .then(() => {
                alert('Booking date updated and moved to queue for approval.');
                loadTeacherBookings(email);
              });
          }
        }
        // Load bookings for this teacher
        loadTeacherBookings(user.email);
      });
    });
  </script>
</body>
</html>