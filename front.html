<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Teacher Booking – Albert Arthur</title>

  <!-- Tailwind & FontAwesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <style>
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-6 max-w-6xl">
    <!-- Header -->
    <header class="mb-6 relative">
      <div class="text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-blue-800">
          Book a Time with Mr. Albert
        </h1>
        <p class="text-gray-600">EdTech Teacher | BINUS School Simprug</p>
      </div>
      <img
        src="./images/simprug.png"
        alt="BINUS School Logo"
        class="absolute top-0 right-0 h-16 w-auto"
      />
    </header>

    <!-- Divider -->
    <div class="flex justify-center mb-6">
      <div class="w-16 h-1 bg-blue-500 rounded-full"></div>
    </div>

    <!-- Banner -->
    <section class="mb-8">
      <img
        src="./images/Albert_motion.jpg"
        alt="Goofy Banner"
        class="w-full h-64 object-cover rounded-lg shadow-md"
      />
    </section>

    <!-- Booking Calendar -->
    <section class="bg-white rounded-lg shadow-md p-6 border border-gray-200 mb-10">
      <h2 class="flex items-center text-xl font-semibold text-gray-800 mb-6">
        <i class="fas fa-calendar-alt text-blue-500 mr-2"></i>
        Available Time Slots
      </h2>
      <p id="loading" class="text-center text-gray-500 mb-4">Loading slots…</p>

      <!-- Days Nav with “All” -->
      <div class="overflow-x-auto mb-6">
        <div id="daysNav" class="flex space-x-4 min-w-max"></div>
      </div>

      <!-- Slots Grid -->
      <div
        id="slotsContainer"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4"
      ></div>
    </section>

    <!-- Gallery -->
    <section class="mb-10">
      <h2 class="text-2xl font-semibold text-center text-blue-800 mb-6">
        Life in Our EdTech Class
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <img src="./images/Grade1.jpg" alt="Grade 1" class="h-60 w-full object-cover rounded-lg shadow-lg" />
        <img src="./images/My_gys.jpg" alt="Fun Activity" class="h-60 w-full object-cover rounded-lg shadow-lg" />
        <img src="./images/Space.jpg" alt="Space Learning" class="h-60 w-full object-cover rounded-lg shadow-lg" />
        <img src="./images/Girlsclub.jpg" alt="Girls Club" class="h-60 w-full object-cover rounded-lg shadow-lg" />
        <img src="./images/Madeit.jpg" alt="Project Success" class="h-60 w-full object-cover rounded-lg shadow-lg" />
        <img src="./images/Coding.jpg" alt="Coding Time" class="h-60 w-full object-cover rounded-lg shadow-lg" />
        <img src="./images/Brainstorming.jpg" alt="Brainstorming" class="h-60 w-full object-cover rounded-lg shadow-lg" />
      </div>
    </section>
  </div>

  <!-- Booking Modal -->
  <div
    id="bookingModal"
    class="fixed inset-0 hidden flex items-center justify-center bg-black bg-opacity-50 z-50"
  >
    <div class="w-full max-w-md mx-4 bg-white rounded-lg p-6 shadow-lg fade-in">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-gray-800">Confirm Booking</h3>
        <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-lg">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <p class="mb-2 text-gray-600">You're booking:</p>
      <p id="slotInfo" class="mb-4 text-blue-600 font-semibold text-lg"></p>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
        <input
          id="studentName"
          type="text"
          placeholder="Enter your name"
          class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
        />
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Your Class</label>
        <input
          id="studentClass"
          type="text"
          placeholder="Enter your class (e.g. 4A)"
          class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
        />
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Your Email</label>
        <input
          id="studentEmail"
          type="email"
          placeholder="Enter your email"
          class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
        />
      </div>
      <div class="flex flex-col sm:flex-row sm:justify-end gap-3 mt-4">
        <button
          id="cancelBtn"
          class="flex-1 sm:flex-none px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition"
        >
          Cancel
        </button>
        <button
          id="confirmBtn"
          class="flex-1 sm:flex-none px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition"
        >
          Confirm Booking
        </button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js"></script>

  <!-- Booking Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs,
      addDoc, query, where, connectFirestoreEmulator
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // Your Firebase config (copy from console)
    const firebaseConfig = {
      apiKey:    "AIzaSyBKhgPEWHqW36Xg0Bx6qwsXq9Hnew0094o",
      authDomain:"school-booking-platform.firebaseapp.com",
      projectId: "school-booking-platform",
      storageBucket: "school-booking-platform.appspot.com",
      messagingSenderId:"673281572597",
      appId:     "1:673281572597:web:fe0ceec0054560f6258fbc",
      measurementId:"G-TVQ5PK5WZF"
    };

    // Init Firebase & Firestore
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // If using emulator locally:
    // connectFirestoreEmulator(db, 'localhost', 8080);

    const bookingsCol = collection(db, "bookings");

    // Predefined time slots
    const timeSlots = {
      Monday:    ["7:30-7:50","9:10-9:30","11:30-12:10","14:10-15:30"],
      Tuesday:   ["7:30-7:50","9:10-9:30","11:30-12:10"],
      Wednesday: ["7:30-7:50","10:50-12:10"],
      Thursday:  ["7:30-7:50","9:10-9:30","11:30-12:10"],
      Friday:    ["7:30-7:50","10:50-11:30","13:30-14:10"]
    };

    // DOM refs
    const loadingEl  = document.getElementById("loading");
    const daysNavEl  = document.getElementById("daysNav");
    const slotsEl    = document.getElementById("slotsContainer");
    const modalEl    = document.getElementById("bookingModal");
    const closeBtn   = document.getElementById("closeModalBtn");
    const cancelBtn  = document.getElementById("cancelBtn");
    const confirmBtn = document.getElementById("confirmBtn");
    const slotInfoEl = document.getElementById("slotInfo");
    const nameInput  = document.getElementById("studentName");
    const classInput = document.getElementById("studentClass");
    const emailInput = document.getElementById("studentEmail");

    let selDay = "", selTime = "";
    let bookedMap = {};

    // Render “All” + day buttons
    function renderDays() {
      daysNavEl.innerHTML = "";
      ["All", ...Object.keys(timeSlots)].forEach(label => {
        const btn = document.createElement("button");
        btn.textContent = label;
        btn.className =
          "px-4 py-2 rounded-md font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition";
        btn.onclick = () => {
          if (label === "All") {
            document.querySelectorAll("#slotsContainer > div")
              .forEach(col => col.classList.remove("hidden"));
          } else {
            filterByDay(label.toLowerCase());
          }
        };
        daysNavEl.appendChild(btn);
      });
    }

    // Render all slots (green) immediately
    function renderSlots() {
      slotsEl.innerHTML = "";
      for (const day in timeSlots) {
        const col = document.createElement("div");
        col.className = "bg-gray-50 rounded-lg p-4";

        const hdr = document.createElement("h3");
        hdr.textContent = day;
        hdr.className = "font-semibold text-lg text-gray-800 mb-3 border-b pb-2";
        col.appendChild(hdr);

        const list = document.createElement("div");
        list.className = "space-y-2";

        timeSlots[day].forEach(time => {
          const key = `${day}-${time}`;
          const isBooked = bookedMap[key];
          const b = document.createElement("button");
          b.textContent = `${time} ${isBooked ? "(Booked)" : "(Available)"}`;
          b.disabled = Boolean(isBooked);
          b.className = `w-full px-3 py-2 rounded border text-white font-medium ${
            isBooked ? "bg-red-500" : "bg-green-500 hover:bg-green-600"
          }`;
          if (!isBooked) b.onclick = () => openModal(day, time);
          list.appendChild(b);
        });

        col.appendChild(list);
        slotsEl.appendChild(col);
      }
    }

    // Fetch & patch booked states
    async function loadBookings() {
      loadingEl.style.display = "block";
      try {
        const snap = await getDocs(bookingsCol);
        bookedMap = {};
        snap.forEach(doc => {
          const b = doc.data();
          bookedMap[`${b.day}-${b.time}`] = true;
        });
        renderSlots();
      } catch (e) {
        slotsEl.innerHTML = `<p class="text-red-600">Failed to load slots.</p>`;
        console.error(e);
      } finally {
        loadingEl.style.display = "none";
      }
    }

    // Show only one day’s column
    function filterByDay(dayKey) {
      document.querySelectorAll("#slotsContainer > div").forEach(col => {
        col.classList.toggle(
          "hidden",
          col.querySelector("h3").textContent.toLowerCase() !== dayKey
        );
      });
    }

    // Open booking modal
    function openModal(day, time) {
      selDay = day; selTime = time;
      slotInfoEl.textContent = `${day} at ${time}`;
      modalEl.classList.replace("hidden","flex");
    }

    // Close modal & reset fields
    function closeModal() {
      modalEl.classList.replace("flex","hidden");
      nameInput.value = "";
      classInput.value = "";
      emailInput.value = "";
    }

    // Confirm booking with domain whitelist
    confirmBtn.addEventListener("click", async () => {
      const name  = nameInput.value.trim();
      const cls   = classInput.value.trim();
      const email = emailInput.value.trim().toLowerCase();

      // Required fields
      if (!name || !cls || !email) {
        return alert("All fields are required.");
      }
      // Domain whitelist
      if (
        !email.endsWith("@binus.edu") &&
        !email.endsWith("@binus.org")
      ) {
        return alert("Please use your school email (…@binus.edu or …@binus.org).");
      }
      // Prevent duplicates
      const dupQ = query(
        bookingsCol,
        where("day","==",selDay),
        where("time","==",selTime)
      );
      if (!(await getDocs(dupQ)).empty) {
        return alert("That slot’s already booked!");
      }

      // Write to Firestore
      await addDoc(bookingsCol, {
        day: selDay,
        time: selTime,
        studentName: name,
        studentClass: cls,
        studentEmail: email,
        createdAt: new Date().toISOString()
      });

      // Update local map & re-render
      bookedMap[`${selDay}-${selTime}`] = true;
      renderSlots();

      // Close modal & show goofy confirmation
      closeModal();
      const overlay = document.createElement("div");
      overlay.className = "fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50";
      overlay.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full fade-in text-center">
          <h2 class="text-2xl font-bold text-green-600 mb-2">Booking Confirmed!</h2>
          <p class="text-gray-700 mb-3">${selTime} on ${selDay}</p>
          <p class="italic text-yellow-600">
            Here we go again… not being paid enough for this huh? 😂
          </p>
        </div>`;
      document.body.appendChild(overlay);
      setTimeout(() => overlay.remove(), 3000);

      // Sync fresh bookings from Firestore
      loadBookings();
    });

    closeBtn.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);

    // Initialize
    renderDays();
    renderSlots();
    loadBookings();
  </script>
</body>
</html>
