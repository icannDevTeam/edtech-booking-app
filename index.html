<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Teacher Booking – Albert Arthur</title>
  <!-- Tailwind & FontAwesome -->
  <!-- Use built Tailwind CSS for production -->
  <link rel="stylesheet" href="/asset/tailwind-built.css">
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <style>
    /* Gallery hover effects */
    .edtech-gallery-img {
      transition: transform 0.35s cubic-bezier(.4,2,.6,1), box-shadow 0.25s;
      cursor: pointer;
    }
    .edtech-gallery-img:hover {
      transform: scale(1.06) rotate(-2deg);
      box-shadow: 0 8px 32px 0 rgba(30,58,138,0.18), 0 1.5px 8px 0 #FFD700;
      z-index: 2;
    }
    /* Discovery Room card hover */
    .discovery-card {
      transition: transform 0.33s cubic-bezier(.4,2,.6,1), box-shadow 0.22s, border-color 0.22s;
      cursor: pointer;
    }
    .discovery-card:hover {
      transform: translateY(-8px) scale(1.04) rotate(1deg);
      box-shadow: 0 8px 32px 0 #FFD70044, 0 1.5px 8px 0 #80000033;
      border-color: #FFD700;
    }
    /* Marquee item hover */
    #discoveryMarquee span[style*="color: #fff"] {
      transition: color 0.22s, text-shadow 0.22s;
      cursor: pointer;
    }
    #discoveryMarquee span[style*="color: #fff"]:hover {
      color: #FFD700 !important;
      text-shadow: 0 0 8px #FFD700, 0 0 2px #fff;
    }
    html, body {
      max-width: 100vw;
      overflow-x: hidden;
    }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    /* Custom scroll for booked slots preview */
    .booked-scroll { max-height: 420px; overflow-y: auto; }
    /* Brand colors */
    .bg-maroon { background-color: #800000; }
    .hover\:bg-maroon-dark:hover { background-color: #660000; }
    .text-maroon { color: #800000; }
    .border-maroon { border-color: #800000; }
    .bg-yellow-brand { background-color: #BFA600; } /* Darker yellow */
    .text-yellow-brand { color: #BFA600; }
    /* Tooltip styles */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 220px;
      background-color: rgba(255,255,255,0.95); /* transparent white */
      color: #1e3a8a; /* dark blue */
      text-align: left;
      border-radius: 6px;
      padding: 8px 12px;
      position: absolute;
      z-index: 10;
      bottom: 120%;
      left: 50%;
      margin-left: -110px;
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 1em;
      pointer-events: none;
      box-shadow: 0 2px 8px rgba(30,58,138,0.08);
      border: 1px solid #dbeafe;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body class="bg-blue-900 min-h-screen">
  <!-- Header Section: Teacher Portal (top left), Logo & Auth (top right), Centered Heading -->
  <div class="container mx-auto px-2 sm:px-4 md:px-6 max-w-full md:max-w-6xl relative">
    <header class="relative flex flex-col items-center justify-center mb-6" style="min-height:120px;">
      <!-- Teacher Portal Top Left -->
      <div id="teacherPortalBtn" class="absolute top-8 left-0 z-20">
        <a id="teacherPortalLink" href="teacher-portal.html" class="inline-flex items-center px-6 py-3 bg-white text-blue-800 font-semibold rounded-full shadow-lg border-2 border-blue-800 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-200 ml-2 cursor-not-allowed opacity-60" tabindex="-1" aria-disabled="true">
          <i class="fas fa-chalkboard-teacher mr-2"></i>
          Teacher Portal
        </a>
      </div>
      <!-- Logo & Auth Top Right -->
      <div class="absolute top-0 right-0 flex flex-col items-end z-20">
        <img src="./images/simprug.png" alt="BINUS School Logo" class="h-20 w-auto mt-4 mr-2" />
        <div id="authBar" class="flex flex-col items-end gap-2 mt-2 mr-8"></div>
      </div>
      <!-- Centered Heading -->
      <div class="w-full flex flex-col items-center justify-center pt-8">
        <h1 class="text-4xl md:text-5xl font-bold text-yellow-200 drop-shadow mb-1 text-center">Discovery Room Booking</h1>
        <p class="text-yellow-100 text-lg text-center">EdTech Teacher Mr. Albert BINUS School Simprug</p>
      </div>
    </header>
  </div>
  <!-- Sign-Up/Sign-In Modal -->
  <div id="authModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50" style="display:none;">
    <div id="authModalContent" class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full fade-in">
      <h2 class="text-2xl font-bold text-blue-800 mb-4">Welcome! Please Sign Up / Sign In</h2>
      <form id="authForm" class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
          <input type="text" id="authName" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
          <input type="email" id="authEmail" required placeholder="Binusian email here." class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
          <select id="authRole" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
            <option value="">Select role</option>
            <option value="teacher">Teacher</option>
            <option value="staff">Staff</option>
          </select>
        </div>
        <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold shadow hover:bg-blue-700 transition">Sign Up / Sign In</button>
      </form>
    </div>
  </div>
  <div class="container mx-auto px-2 sm:px-4 md:px-6 py-8 max-w-full md:max-w-6xl relative" id="mainContent">
    <!-- ...existing code... -->

    <!-- Banner -->
    <section class="mb-10">
      <img
        src="./images/Albert_motion.jpg"
        alt="Goofy Banner"
        class="w-full h-72 object-cover rounded-xl shadow-xl border-4 border-yellow-200"
      />
    </section>
  <!-- Device Borrowing Coming Soon -->
  <style>
    @keyframes bounceIn {
      0% { opacity: 0; transform: scale(0.7) translateY(60px); }
      60% { opacity: 1; transform: scale(1.05) translateY(-10px); }
      80% { transform: scale(0.98) translateY(4px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }
    @keyframes device-borrow-zoom {
      0%, 100% { transform: scale(1); }
      20% { transform: scale(1.06); }
      40% { transform: scale(1.12); }
      60% { transform: scale(1.06); }
      80% { transform: scale(1); }
    }
    .device-borrow-animate {
      animation: bounceIn 1.1s cubic-bezier(.4,2,.6,1) 0.2s both, device-borrow-zoom 2.8s cubic-bezier(.4,2,.6,1) 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { color: #FFD600; text-shadow: 0 0 0 #FFD600; }
      50% { color: #FFB300; text-shadow: 0 0 12px #FFD600, 0 0 2px #fff; }
    }
    .device-borrow-pulse { animation: pulse 1.2s infinite; }
  </style>
  <section class="mb-12">
    <div class="bg-white border-4 border-yellow-400 rounded-2xl shadow-2xl p-8 flex flex-col items-center justify-center relative device-borrow-animate" style="overflow:hidden;">
      <div style="position:absolute;top:0;left:0;width:100%;height:16px;background:linear-gradient(90deg,#FFD600 60%,#FFF7AE 100%);border-radius:16px 16px 0 0;"></div>
      <h2 class="text-2xl md:text-3xl font-bold text-yellow-700 mb-2 flex items-center mt-2">
        <i class="fas fa-laptop mr-3 device-borrow-pulse"></i>
        Device Borrowing <span class="ml-2 text-yellow-600">Coming Soon!</span>
      </h2>
      <p class="text-gray-800 text-lg text-center max-w-2xl mb-2">Soon, you’ll be able to borrow <span class="font-semibold text-yellow-700">Chromebooks, iPads, VR headsets, robots</span>, and more directly from this platform.</p>
      <div class="mt-2 px-4 py-2 bg-yellow-100 border border-yellow-300 rounded-lg text-yellow-900 font-medium shadow-sm">Stay tuned for updates!</div>
    </div>
  </section>

    <!-- Booking Calendar -->
    <section class="bg-white rounded-xl shadow-xl p-8 border border-gray-200 mb-12">
      <h2 class="flex items-center text-2xl font-bold text-gray-800 mb-8">
        <i class="fas fa-calendar-alt text-blue-500 mr-3"></i>
        Pick Your Date & Slot
      </h2>
      <!-- Date Range Picker -->
      <div class="flex flex-col md:flex-row gap-6 mb-6">
        <div class="flex-1">
          <label for="bookingDate" class="block text-base font-medium text-gray-700 mb-2">
            Select a date (single)
          </label>
          <input
            type="date"
            id="bookingDate"
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div class="flex-1">
          <label class="block text-base font-medium text-gray-700 mb-2">
            Or pick a date range
          </label>
          <div class="flex gap-3">
            <input
              type="date"
              id="rangeStart"
              class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
            />
            <span class="self-center">to</span>
            <input
              type="date"
              id="rangeEnd"
              class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
            />
          </div>
        </div>
      </div>
      <div class="flex flex-col lg:flex-row gap-10">
        <div class="flex-1">
          <p id="loading" class="text-center text-gray-500 mb-6 hidden">Loading slots…</p>
          <div
            id="slotsContainer"
            class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-2 gap-6"
          ></div>
        </div>
        <!-- Booked Slots Preview -->
        <aside class="w-full lg:w-80 bg-gray-50 border border-gray-200 rounded-xl p-6 booked-scroll">
          <h3 class="text-xl font-bold text-blue-700 mb-4 flex items-center">
            <i class="fas fa-list mr-3"></i>Booked Slots
          </h3>
          <ul id="bookedPreview" class="space-y-3 text-base"></ul>
        </aside>
      </div>
    </section>

    <!-- Gallery -->
    <section class="mb-12">
      <h2 class="text-3xl font-bold text-center text-yellow-200 mb-8">
        Life in Our EdTech Class
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        <img src="./images/Grade1.jpg" alt="Grade 1" class="edtech-gallery-img h-64 w-full object-cover rounded-xl shadow-xl border-2 border-yellow-200" />
        <img src="./images/My_gys.jpg" alt="Fun Activity" class="edtech-gallery-img h-64 w-full object-cover rounded-xl shadow-xl border-2 border-yellow-200" />
        <img src="./images/Space.jpg" alt="Space Learning" class="edtech-gallery-img h-64 w-full object-cover rounded-xl shadow-xl border-2 border-yellow-200" />
        <img src="./images/Girlsclub.jpg" alt="Girls Club" class="edtech-gallery-img h-64 w-full object-cover rounded-xl shadow-xl border-2 border-yellow-200" />
        <img src="./images/Madeit.jpg" alt="Project Success" class="edtech-gallery-img h-64 w-full object-cover rounded-xl shadow-xl border-2 border-yellow-200" />
        <img src="./images/Coding.jpg" alt="Coding Time" class="edtech-gallery-img h-64 w-full object-cover rounded-xl shadow-xl border-2 border-yellow-200" />
      </div>
    </section>
  </div>

  <!-- Booking Modal -->
  <div
    id="bookingModal"
    class="fixed inset-0 hidden flex items-center justify-center bg-black bg-opacity-50 z-50"
  >
    <div class="w-full max-w-md mx-4 bg-white rounded-lg p-6 shadow-lg fade-in">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-gray-800">Confirm Booking</h3>
        <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-lg">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <p class="mb-2 text-gray-600">You're booking:</p>
      <p id="slotInfo" class="mb-4 text-blue-600 font-semibold text-lg"></p>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
        <input
          id="studentName"
          type="text"
          placeholder="Enter your name"
          class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
        />
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Your Class</label>
        <input
          id="studentClass"
          type="text"
          placeholder="Enter your class (e.g. 4A)"
          class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
        />
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Your Email</label>
        <input
          id="studentEmail"
          type="email"
          placeholder="Binusian email here."
          class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
        />
      </div>
      <div class="flex flex-col sm:flex-row sm:justify-end gap-3 mt-4">
        <button
          id="cancelBtn"
          class="flex-1 sm:flex-none px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition"
        >
          Cancel
        </button>
        <button
          id="confirmBtn"
          class="flex-1 sm:flex-none px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition"
        >
          Confirm Booking
        </button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <!-- Remove non-module Firebase scripts; use ES module imports below -->

  <!-- Booking Logic -->
  <script type="module">
    // --- Auth Bar Logic ---
    const authBar = document.getElementById("authBar");
    function renderAuthBar() {
      const user = getUser();
      authBar.innerHTML = "";
      const teacherPortalBtn = document.getElementById("teacherPortalBtn");
      const teacherPortalLink = document.getElementById("teacherPortalLink");
      if (user && user.name) {
        // Only enable Teacher Portal if approved
        import("https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js").then(async ({getFirestore, collection, query, where, getDocs}) => {
          const db = getFirestore();
          const usersCol = collection(db, "users");
          const q = query(usersCol, where("email", "==", user.email));
          const snap = await getDocs(q);
          let userDoc = null;
          snap.forEach(doc => userDoc = doc);
          if (userDoc && userDoc.data().approved) {
            teacherPortalLink.classList.remove("cursor-not-allowed", "opacity-60");
            teacherPortalLink.setAttribute("tabindex", "0");
            teacherPortalLink.removeAttribute("aria-disabled");
            teacherPortalLink.onclick = null; // allow navigation
          } else {
            teacherPortalLink.classList.add("cursor-not-allowed", "opacity-60");
            teacherPortalLink.setAttribute("tabindex", "-1");
            teacherPortalLink.setAttribute("aria-disabled", "true");
            teacherPortalLink.onclick = (e) => { e.preventDefault(); };
          }
        });
        // Auth bar only shows user info and logout
        const nameSpan = document.createElement("span");
        nameSpan.className = "text-white font-semibold px-3 py-1 rounded bg-blue-800";
        nameSpan.textContent = `Hello, ${user.name}`;
        const logoutBtn = document.createElement("button");
        logoutBtn.className = "px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition";
        logoutBtn.textContent = "Logout";
        logoutBtn.onclick = () => {
          localStorage.removeItem("edtechUser");
          teacherPortalLink.classList.add("cursor-not-allowed", "opacity-60");
          teacherPortalLink.setAttribute("tabindex", "-1");
          teacherPortalLink.setAttribute("aria-disabled", "true");
          teacherPortalLink.onclick = (e) => { e.preventDefault(); };
          renderAuthBar();
        };
        authBar.appendChild(nameSpan);
        authBar.appendChild(logoutBtn);
      } else {
        // Auth bar only shows main Sign Up / Sign In, never Teacher Portal login
        teacherPortalLink.classList.add("cursor-not-allowed", "opacity-60");
        teacherPortalLink.setAttribute("tabindex", "-1");
        teacherPortalLink.setAttribute("aria-disabled", "true");
        teacherPortalLink.onclick = (e) => { e.preventDefault(); };
        // Horizontal flex container for links
        const linkBar = document.createElement("div");
        linkBar.className = "flex gap-4 mt-2";

        // Login link
        const loginLink = document.createElement("a");
        loginLink.href = "#";
        loginLink.className = "text-blue-400 underline text-base font-semibold hover:text-yellow-200 transition";
        loginLink.textContent = "Login";
        loginLink.onclick = (e) => {
          e.preventDefault();
          showEmailPasswordLoginModal();
        };
        linkBar.appendChild(loginLink);

        // Sign Up link
        const signupLink = document.createElement("a");
        signupLink.href = "#";
        signupLink.className = "text-green-400 underline text-base font-semibold hover:text-yellow-200 transition";
        signupLink.textContent = "Sign Up";
        signupLink.onclick = (e) => {
          e.preventDefault();
          showAuthModal();
        };
        linkBar.appendChild(signupLink);

        authBar.appendChild(linkBar);
        // Ensure Teacher Portal never opens auth modal
        teacherPortalLink.onclick = (e) => { e.preventDefault(); };

    // --- Email/Password Login Modal Logic ---
    function showEmailPasswordLoginModal() {
      let old = document.getElementById("emailPasswordLoginModal");
      if (old) old.remove();
      const modal = document.createElement("div");
      modal.id = "emailPasswordLoginModal";
      modal.className = "fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50";
      modal.innerHTML = `
        <div class="bg-blue-800 text-white p-8 rounded-xl shadow-2xl max-w-md w-full fade-in">
          <h2 class="text-2xl font-bold mb-4">Login</h2>
          <form id="emailPasswordLoginForm" class="space-y-6">
            <div>
              <label class="block text-sm font-medium mb-2">Email</label>
              <input type="email" id="loginEmail" required class="w-full px-4 py-3 border rounded-lg text-black" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Password (Code from Email)</label>
              <input type="text" id="loginPassword" required class="w-full px-4 py-3 border rounded-lg text-black" />
            </div>
            <button type="submit" class="w-full px-6 py-3 bg-yellow-500 text-maroon rounded-lg font-semibold shadow hover:bg-yellow-600 transition">Login</button>
          </form>
          <button id="closeEmailPasswordLoginBtn" class="mt-6 px-4 py-2 border rounded text-white hover:bg-gray-100 hover:text-black">Close</button>
        </div>
      `;
      document.body.appendChild(modal);
      setTimeout(() => {
        function outsideClick(e) {
          const content = modal.querySelector(".fade-in");
          if (content && !content.contains(e.target)) {
            modal.remove();
            document.removeEventListener("mousedown", outsideClick);
          }
        }
        document.addEventListener("mousedown", outsideClick);
        modal._outsideClick = outsideClick;
      }, 100);
      modal.querySelector("#closeEmailPasswordLoginBtn").onclick = () => {
        modal.remove();
        if (modal._outsideClick) document.removeEventListener("mousedown", modal._outsideClick);
      };
      modal.querySelector("#emailPasswordLoginForm").onsubmit = async (e) => {
        e.preventDefault();
        const email = modal.querySelector("#loginEmail").value.trim().toLowerCase();
        const password = modal.querySelector("#loginPassword").value.trim();
        if (!email || !password) {
          alert("All fields are required.");
          return;
        }
        if (!email.endsWith("@binus.edu") && !email.endsWith("@binus.org")) {
          alert("Use your school email (@binus.edu or @binus.org)." );
          return;
        }
        import("https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js").then(async ({getFirestore, collection, query, where, getDocs}) => {
          const db = getFirestore();
          const usersCol = collection(db, "users");
          const q = query(usersCol, where("email", "==", email));
          const snap = await getDocs(q);
          let userDoc = null;
          snap.forEach(doc => userDoc = doc);
          if (!userDoc) {
            alert("No account found. Please sign up first.");
            return;
          }
          const userData = userDoc.data();
          if (userData.password !== password) {
            alert("Incorrect code/password. Please check your email.");
            return;
          }
          setUser({ name: userData.name, email: userData.email, role: userData.role, id: userDoc.id });
          modal.remove();
          renderAuthBar();
          setTimeout(() => {
            if (!document.getElementById("welcomeMsg")) {
              const msg = document.createElement("div");
              msg.id = "welcomeMsg";
              msg.className = "fixed top-4 right-4 bg-blue-800 text-white px-4 py-2 rounded shadow-lg z-50 fade-in";
              msg.textContent = `Welcome, ${userData.name}!`;
              document.body.appendChild(msg);
              setTimeout(()=>msg.remove(), 3500);
            }
          }, 500);
        });
      };
    }
      }
    }
    renderAuthBar();
    // --- Auth Modal Logic ---
    const authModal = document.getElementById("authModal");
    const authForm = document.getElementById("authForm");
    const authName = document.getElementById("authName");
    const authEmail = document.getElementById("authEmail");
    const authRole = document.getElementById("authRole");
    const mainContent = document.getElementById("mainContent");
    // Booking calendar DOM refs
    const dateInput = document.getElementById("bookingDate");
    const rangeStart = document.getElementById("rangeStart");
    const rangeEnd = document.getElementById("rangeEnd");
    const slotsEl = document.getElementById("slotsContainer");
    const bookedPreview = document.getElementById("bookedPreview");
    const loadingEl = document.getElementById("loading");
    // Modal refs
    const modalEl = document.getElementById("bookingModal");
    const slotInfoEl = document.getElementById("slotInfo");
    const nameInput = document.getElementById("studentName");
    const classInput = document.getElementById("studentClass");
    const emailInput = document.getElementById("studentEmail");
    const closeBtn = document.getElementById("closeModalBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const confirmBtn = document.getElementById("confirmBtn");

    function showAuthModal() {
      authModal.style.display = "flex";
      setTimeout(() => {
        function outsideClick(e) {
          const modalContent = document.getElementById("authModalContent");
          if (authModal.style.display === "flex" && modalContent && !modalContent.contains(e.target)) {
            hideAuthModal();
            document.removeEventListener("mousedown", outsideClick);
          }
        }
        document.addEventListener("mousedown", outsideClick);
        authModal._outsideClick = outsideClick;
      }, 100);
    }
    function hideAuthModal() {
      authModal.style.display = "none";
      if (authModal._outsideClick) {
        document.removeEventListener("mousedown", authModal._outsideClick);
        delete authModal._outsideClick;
      }
    }
    function getUser() {
      try {
        return JSON.parse(localStorage.getItem("edtechUser"));
      } catch { return null; }
    }
    function setUser(user) {
      localStorage.setItem("edtechUser", JSON.stringify(user));
    }
    authForm.onsubmit = function(e) {
      e.preventDefault();
      const name = authName.value.trim();
      const email = authEmail.value.trim().toLowerCase();
      const role = authRole.value;
      if (!name || !email || !role) {
        alert("All fields are required.");
        return;
      }
      // Check if user exists
      import("https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js").then(async ({getFirestore, collection, query, where, getDocs, addDoc}) => {
        const db = getFirestore();
        const usersCol = collection(db, "users");
        const q = query(usersCol, where("email", "==", email));
        const snap = await getDocs(q);
        let userDoc = null;
        snap.forEach(doc => userDoc = doc);
        if (!userDoc) {
          // Register new user, generate password code
          const password = Math.random().toString(36).slice(-8).toUpperCase();
          await addDoc(usersCol, {
            name, email, role, password, approved: true, createdAt: new Date().toISOString()
          });
          // Nodemailer (via Firebase Function) will send the code email automatically
          alert("Sign-up successful! Your code has been sent to your email. Use it to log in.");
          hideAuthModal();
          renderAuthBar();
          return;
        }
        const userData = userDoc.data();
        alert("Account already exists. Please log in.");
        hideAuthModal();
        renderAuthBar();
      });
    // EmailJS logic removed. All sign-up code emails are now sent by the backend (Firebase Function with Nodemailer).
    };
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, addDoc,
      query, where, connectFirestoreEmulator
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // Firebase config (copy yours)
    const firebaseConfig = {
      apiKey:    "AIzaSyBKhgPEWHqW36Xg0Bx6qwsXq9Hnew0094o",
      authDomain:"school-booking-platform.firebaseapp.com",
      projectId: "school-booking-platform",
      storageBucket: "school-booking-platform.appspot.com",
      messagingSenderId:"673281572597",
      appId:     "1:673281572597:web:fe0ceec0054560f6258fbc",
      measurementId:"G-TVQ5PK5WZF"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    // If you run the emulator locally:
    // connectFirestoreEmulator(db, 'localhost', 8080);

    // Firestore collection
    const bookingsCol = collection(db, "bookings");
    // Add waiting list collection
    const waitingCol = collection(db, "waiting_list");

    // Hard-coded slots by weekday
    const timeSlots = {
  Monday:    ["7:30-7:50","9:10-9:30","11:30-12:10","14:10-15:30"],
  Tuesday:   ["7:30-7:50","9:10-9:30","11:30-12:10"],
  Wednesday: ["7:30-7:50","10:50-12:10"],
  Thursday:  ["7:30-7:50","9:10-9:30","11:30-12:10"],
  Friday:    ["7:30-7:50","13:30-14:10","14:10-15:30","13:30-14:10","14:10-15:30"]
    };

    // DOM refs
    // ...existing code...

    let selDate = "", selTime = "";
    let bookedTimes = new Set();
    let bookedDetails = [];

    // Initialize date picker range → today … today+6
    const today = new Date();
    const pad = n => n.toString().padStart(2,"0");
    const iso = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    dateInput.min = iso(today);
    rangeStart.min = iso(today);
    rangeEnd.min = iso(today);
  const maxDate = new Date(today.getTime() + 13*24*60*60*1000);
    dateInput.max = iso(maxDate);
    rangeStart.max = iso(maxDate);
    rangeEnd.max = iso(maxDate);
    dateInput.value = iso(today);

    // Listen for changes
    dateInput.addEventListener("change", ()=>{
      rangeStart.value = "";
      rangeEnd.value = "";
      loadBookings();
    });
    rangeStart.addEventListener("change", ()=>{
      dateInput.value = "";
      if(rangeEnd.value && rangeEnd.value < rangeStart.value) rangeEnd.value = rangeStart.value;
      loadBookings();
    });
    rangeEnd.addEventListener("change", ()=>{
      dateInput.value = "";
      if(rangeStart.value && rangeEnd.value < rangeStart.value) rangeStart.value = rangeEnd.value;
      loadBookings();
    });

    // Helper: get all dates in range
    function getDatesInRange(start, end){
      const dates = [];
      let d = new Date(start);
      const last = new Date(end);
      while(d <= last){
        dates.push(iso(d));
        d.setDate(d.getDate()+1);
      }
      return dates;
    }

    // Load bookings for single date or range
    async function loadBookings(){
      bookedTimes.clear();
      bookedDetails = [];
      slotsEl.innerHTML = "";
      bookedPreview.innerHTML = "";
      let dates = [];
      if(dateInput.value){
        selDate = dateInput.value;
        dates = [selDate];
      } else if(rangeStart.value && rangeEnd.value){
        dates = getDatesInRange(rangeStart.value, rangeEnd.value);
      } else {
        return;
      }
      loadingEl.classList.remove("hidden");
      try {
        // Query all bookings in date(s)
        const q = query(bookingsCol, where("date", ">=", dates[0]), where("date", "<=", dates[dates.length-1]));
        const snap = await getDocs(q);
        snap.forEach(doc => {
          const data = doc.data();
          bookedTimes.add(`${data.date}|${data.time}`);
          bookedDetails.push(data);
        });
        renderSlots(dates);
        renderBookedPreview();
      } catch(e){
        slotsEl.innerHTML = `<p class="text-red-600">Failed to load slots.</p>`;
        console.error(e);
      } finally {
        loadingEl.classList.add("hidden");
      }
    }

    // Helper: format date as DD/MM/YY
    function formatDateDDMMYY(dateStr) {
      const [y, m, d] = dateStr.split("-");
      return `${d}/${m}/${y.slice(2)}`;
    }

    // Render slots for all selected dates
    function renderSlots(dates){
      slotsEl.innerHTML = "";
      dates.forEach(dateStr => {
        const weekday = new Date(dateStr).toLocaleDateString("en-US",{weekday:"long"});
        const times = timeSlots[weekday];
        if(!times) return;
        const col = document.createElement("div");
        col.className = "bg-gray-50 rounded-lg p-4";
        const hdr = document.createElement("h3");
        hdr.textContent = `${weekday} — ${formatDateDDMMYY(dateStr)}`;
        hdr.className = "font-semibold text-lg text-gray-800 mb-3 border-b pb-2";
        col.appendChild(hdr);
        const list = document.createElement("div");
        list.className = "space-y-2";
        times.forEach(time => {
          const bookedKey = `${dateStr}|${time}`;
          const booked = bookedTimes.has(bookedKey);
          let btn;
          if (booked) {
            // Find booking details for tooltip
            const b = bookedDetails.find(bd => bd.date === dateStr && bd.time === time);
            btn = document.createElement("div");
            btn.className = "tooltip";
            const button = document.createElement("button");
            button.textContent = `${time} (Booked)`;
            button.disabled = true;
            button.className = "w-full px-3 py-2 rounded border text-white font-medium bg-red-500 cursor-not-allowed";
            btn.appendChild(button);
            // Tooltip content: transparent white, dark blue, only teacher name and time
            const tip = document.createElement("span");
            tip.className = "tooltiptext";
            tip.innerHTML = b
              ? `<div><span class="font-bold">Teacher:</span> <span>${b.studentName}</span></div>
                 <div><span class="font-bold">Time:</span> <span>${b.time}</span></div>`
              : "";
            btn.appendChild(tip);
          } else {
            btn = document.createElement("button");
            btn.textContent = `${time} (Available)`;
            btn.disabled = false;
            btn.className = "w-full px-3 py-2 rounded border text-white font-medium bg-green-500 hover:bg-green-600";
            btn.onclick = () => openModal(dateStr, time);
          }
          list.appendChild(btn);
        });
        col.appendChild(list);
        slotsEl.appendChild(col);
      });
    }

    // Render vertical preview of booked slots
    function renderBookedPreview(){
      if(!bookedDetails.length){
        bookedPreview.innerHTML = `<li class="text-gray-400">No bookings yet.</li>`;
        return;
      }
      // Sort by date/time
      bookedDetails.sort((a,b)=>{
        if(a.date!==b.date) return a.date.localeCompare(b.date);
        return a.time.localeCompare(b.time);
      });
      bookedPreview.innerHTML = bookedDetails.map(b=>
        `<li class="border-l-4 border-blue-400 pl-2 py-1 bg-white rounded">
          <span class="font-semibold text-blue-800">${formatDateDDMMYY(b.date)}</span>
          <span class="ml-2 text-gray-700">${b.time}</span>
          <div class="text-xs text-gray-500">${b.studentName} (${b.studentClass})</div>
        </li>`
      ).join("");
    }

    // Show the booking modal (now passes date)
    function openModal(date, time){
      const user = getUser();
      if (!user || !user.name || !user.email || !user.role) {
        showAuthModal();
        return;
      }
      // Check approval status before allowing booking
      import("https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js").then(async ({getFirestore, collection, query, where, getDocs}) => {
        const db = getFirestore();
        const usersCol = collection(db, "users");
        const q = query(usersCol, where("email", "==", user.email));
        const snap = await getDocs(q);
        let userDoc = null;
        snap.forEach(doc => userDoc = doc);
        if (!userDoc || !userDoc.data().approved) {
          alert("Your account is not approved yet. Please wait for admin confirmation.");
          return;
        }
        selDate = date;
        selTime = time;
        slotInfoEl.textContent = `${formatDateDDMMYY(selDate)} @ ${selTime}`;
        modalEl.classList.replace("hidden","flex");
      });
    }

    // Hide modal + reset inputs
    function closeModal(){
      modalEl.classList.replace("flex","hidden");
      nameInput.value = "";
      classInput.value = "";
      emailInput.value = "";
    }

    // --- Make cancel and close buttons work ---
    closeBtn.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);

    // Add: Helper to create ICS file content
    function createICS({date, time, name, cls, email}) {
      // Parse time range
      const [startStr, endStr] = time.split("-");
      const [year, month, day] = date.split("-");
      function toICSDate(t) {
        const [h, m] = t.split(":");
        // Pad month/day
        return `${year}${month.padStart(2,"0")}${day.padStart(2,"0")}T${h.padStart(2,"0")}${m}00`;
      }
      const dtStart = toICSDate(startStr);
      const dtEnd = toICSDate(endStr);
      return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//EdTech Booking//EN
BEGIN:VEVENT
UID:${date}-${time}-${email}
DTSTAMP:${dtStart}Z
DTSTART:${dtStart}Z
DTEND:${dtEnd}Z
SUMMARY:Meeting with Mr. Albert
DESCRIPTION:EdTech Booking for ${name} (${cls})\\nEmail: ${email}
LOCATION:BINUS School Simprug
END:VEVENT
END:VCALENDAR`;
    }

    // Confirm & write to Firestore
    confirmBtn.addEventListener("click", async ()=>{
      // Use logged-in user info for booking
      const user = getUser();
      const name  = user?.name || nameInput.value.trim();
      const cls   = classInput.value.trim();
      const email = user?.email || emailInput.value.trim().toLowerCase();

      if(!name||!cls||!email) {
        return alert("All fields are required.");
      }
      // Double-check duplicate
      if(bookedTimes.has(`${selDate}|${selTime}`)){
        // Slot is booked, offer waiting list
        showWaitingListModal(selDate, selTime, name, cls, email);
        return;
      }
      try {
        await addDoc(bookingsCol, {
          date: selDate,
          time: selTime,
          studentName: name,
          studentClass: cls,
          studentEmail: email,
          status: "confirmed",
          createdAt: new Date().toISOString()
        });
        bookedTimes.add(`${selDate}|${selTime}`);
        bookedDetails.push({
          date: selDate, time: selTime,
          studentName: name, studentClass: cls, status: "confirmed"
        });
        renderSlots(dateInput.value ? [selDate] : getDatesInRange(rangeStart.value, rangeEnd.value));
        renderBookedPreview();
        closeModal();

        // Call email service after booking is confirmed
        try {
          // Use dynamic import for emailService.js
          const { sendBookingConfirmation } = await import('./backend/services/emailService.js');
          sendBookingConfirmation({
            name,
            email,
            date: selDate,
            time: selTime,
            cls
          });
        } catch (err) {
          console.warn("Email service failed:", err);
        }

        // Show invoice/confirmation with Add to Calendar
        showInvoiceOverlay({
          date: selDate, time: selTime,
          name, cls, email
        });
      } catch(e){
        console.error(e);
        alert("Failed to save booking, please try again.");
      }
    });

    // --- Invoice Overlay with Add to Calendar ---
    function showInvoiceOverlay({date, time, name, cls, email}) {
      const overlay = document.createElement("div");
      overlay.className = "fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50";
      const icsContent = createICS({date, time, name, cls, email});
      const icsBlob = new Blob([icsContent], {type: "text/calendar"});
      const icsUrl = URL.createObjectURL(icsBlob);

      overlay.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full fade-in text-center">
          <h2 class="text-2xl font-bold text-green-600 mb-2">Booking Confirmed!</h2>
          <div class="mb-3 text-left">
            <div class="font-semibold text-blue-800">Date:</div>
            <div>${formatDateDDMMYY(date)}</div>
            <div class="font-semibold text-blue-800 mt-2">Time:</div>
            <div>${time}</div>
            <div class="font-semibold text-blue-800 mt-2">Name:</div>
            <div>${name} (${cls})</div>
            <div class="font-semibold text-blue-800 mt-2">Email:</div>
            <div>${email}</div>
          </div>
          <a href="${icsUrl}" download="booking.ics"
            class="inline-block mt-3 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
            >Add to Calendar (Outlook/Google)</a>
          <p class="italic text-yellow-600 mt-4">
            Thanks for booking! If this made you smile, my job here is done. Have a wonderful day and keep being awesome! 😄
          </p>
          <!-- Add to Calendar Buttons -->
          <div class="flex justify-center space-x-4 mt-4">
            <button id="addGoogleCalBtn" class="px-4 py-2 bg-yellow-brand text-maroon rounded hover:bg-yellow-400 transition">
              Add to Google Calendar
            </button>
            <button id="addOutlookCalBtn" class="px-4 py-2 bg-maroon text-white rounded hover:bg-maroon-dark transition">
              Add to Outlook Calendar
            </button>
          </div>
          <button class="mt-6 px-4 py-2 border rounded text-gray-700 hover:bg-gray-100" id="closeInvoiceBtn">Close</button>
        </div>`;
      document.body.appendChild(overlay);
      overlay.querySelector("#closeInvoiceBtn").onclick = () => {
        overlay.remove();
        URL.revokeObjectURL(icsUrl);
      };

      // Add to Calendar handlers
      const encode = encodeURIComponent;
      function getCalTimes(date, time) {
        // date: YYYY-MM-DD, time: "HH:MM-HH:MM"
        const [startStr, endStr] = time.split("-");
        const [year, month, day] = date.split("-");
        function pad(n) { return n.padStart(2, "0"); }
        // Google: YYYYMMDDTHHMMSSZ (UTC), Outlook: ISO
        const start = `${year}${pad(month)}${pad(day)}T${startStr.replace(":","")}00Z`;
        const end   = `${year}${pad(month)}${pad(day)}T${endStr.replace(":","")}00Z`;
        const startISO = `${year}-${pad(month)}-${pad(day)}T${startStr}:00Z`;
        const endISO   = `${year}-${pad(month)}-${pad(day)}T${endStr}:00Z`;
        return { start, end, startISO, endISO };
      }
      const calTitle = "Meeting with Mr. Albert";
      const calDesc = `EdTech Booking for ${name} (${cls})\\nEmail: ${email}`;
      const calLoc = "BINUS School Simprug";
      const { start, end, startISO, endISO } = getCalTimes(date, time);

      overlay.querySelector("#addGoogleCalBtn").onclick = () => {
        const url = `https://calendar.google.com/calendar/render?action=TEMPLATE`
          + `&text=${encode(calTitle)}`
          + `&dates=${start}/${end}`
          + `&details=${encode(calDesc)}`
          + `&location=${encode(calLoc)}`;
        window.open(url, '_blank');
      };
      overlay.querySelector("#addOutlookCalBtn").onclick = () => {
        const url = `https://outlook.live.com/calendar/0/deeplink/compose?path=/calendar/view/Month&rru=addevent`
          + `&startdt=${encode(startISO)}`
          + `&enddt=${encode(endISO)}`
          + `&subject=${encode(calTitle)}`
          + `&body=${encode(calDesc)}`
          + `&location=${encode(calLoc)}`;
        window.open(url, '_blank');
      };
    }

    // --- Waiting List Modal ---
    function showWaitingListModal(date, time, name, cls, email) {
      // Remove any existing modal
      let old = document.getElementById("waitingListModal");
      if (old) old.remove();
      const modal = document.createElement("div");
      modal.id = "waitingListModal";
      modal.className = "fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50";
      modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full fade-in">
          <h3 class="text-xl font-semibold text-gray-800 mb-2">Slot Already Booked</h3>
          <p class="mb-2 text-gray-600">Would you like to join the waiting list for:</p>
          <div class="mb-2 text-maroon font-semibold">${formatDateDDMMYY(date)} @ ${time}</div>
          <form id="waitingForm" class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
              <input type="text" id="waitName" value="${name||""}" required
                class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Your Class</label>
              <input type="text" id="waitClass" value="${cls||""}" required
                class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Your Email</label>
              <input type="email" id="waitEmail" value="${email||""}" required
                placeholder="Binusian email here."
                class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500" />
            </div>
            <div class="flex flex-col sm:flex-row sm:justify-end gap-3 mt-4">
              <button type="button" id="cancelWaitBtn"
                class="flex-1 sm:flex-none px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition"
              >Cancel</button>
              <button type="submit"
                class="flex-1 sm:flex-none px-4 py-2 bg-maroon text-white rounded hover:bg-maroon-dark transition"
              >Join Waiting List</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      modal.querySelector("#cancelWaitBtn").onclick = () => modal.remove();
      modal.querySelector("#waitingForm").onsubmit = async (e) => {
        e.preventDefault();
        const waitName = modal.querySelector("#waitName").value.trim();
        const waitClass = modal.querySelector("#waitClass").value.trim();
        const waitEmail = modal.querySelector("#waitEmail").value.trim().toLowerCase();
        if(!waitName||!waitClass||!waitEmail){
          alert("All fields are required.");
          return;
        }
        try {
          await addDoc(waitingCol, {
            date, time,
            studentName: waitName,
            studentClass: waitClass,
            studentEmail: waitEmail,
            createdAt: new Date().toISOString()
          });
          modal.remove();
          showWaitingListConfirmation({date, time, waitName, waitClass, waitEmail});
        } catch(e){
          alert("Failed to join waiting list, please try again.");
        }
      };
    }

    // --- Waiting List Confirmation Overlay ---
    function showWaitingListConfirmation({date, time, waitName, waitClass, waitEmail}) {
      const overlay = document.createElement("div");
      overlay.className = "fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50";
      // Fetch queue position
      import("https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js").then(async ({getFirestore, collection, query, where, getDocs}) => {
        const db = getFirestore();
        const waitingCol = collection(db, "waiting_list");
        const q = query(waitingCol, where("date", "==", date), where("time", "==", time));
        const snap = await getDocs(q);
        let queueNum = 1;
        let found = false;
        snap.forEach(doc => {
          const d = doc.data();
          if (d.studentEmail === waitEmail) found = true;
          if (!found) queueNum++;
        });
        overlay.innerHTML = `
          <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full fade-in text-center">
            <h2 class="text-2xl font-bold text-blue-600 mb-2">Added to Waiting List!</h2>
            <div class="mb-3 text-left">
              <div class="font-semibold text-blue-800">Date:</div>
              <div>${formatDateDDMMYY(date)}</div>
              <div class="font-semibold text-blue-800 mt-2">Time:</div>
              <div>${time}</div>
              <div class="font-semibold text-blue-800 mt-2">Name:</div>
              <div>${waitName} (${waitClass})</div>
              <div class="font-semibold text-blue-800 mt-2">Email:</div>
              <div>${waitEmail}</div>
              <div class="font-semibold text-green-700 mt-2">Your Queue Number:</div>
              <div class="text-green-700 text-xl font-bold">${queueNum}</div>
            </div>
            <p class="italic text-yellow-600 mt-4">
              We'll notify you if this slot becomes available!
            </p>
            <button class="mt-6 px-4 py-2 border rounded text-gray-700 hover:bg-gray-100" id="closeWaitBtn">Close</button>
          </div>`;
        document.body.appendChild(overlay);
        overlay.querySelector("#closeWaitBtn").onclick = () => overlay.remove();
      });
    }

    // Kick things off
    loadBookings();
  </script>
  <!-- Simple Chatbot Widget -->
  <style>
    #chatbotWidgetBtn {
      position: fixed; bottom: 32px; right: 32px; z-index: 100;
      background: #2563eb; color: #fff; border-radius: 50%; width: 60px; height: 60px;
      display: flex; align-items: center; justify-content: center; font-size: 2em;
      box-shadow: 0 4px 16px #0002; cursor: pointer;
      transition: background 0.2s;
    }
    #chatbotWidgetBtn:hover { background: #1742a0; }
    #chatbotWidget {
      position: fixed; bottom: 110px; right: 32px; z-index: 101;
      width: 320px; max-width: 95vw;
      background: #fff; border-radius: 16px; box-shadow: 0 8px 32px #0003;
      display: none; flex-direction: column;
    }
    #chatbotHeader { background: #2563eb; color: #fff; border-radius: 16px 16px 0 0; padding: 14px 18px; font-weight: bold; font-size: 1.1em; display: flex; align-items: center; justify-content: space-between; }
    #chatbotClose { background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; }
    #chatbotMessages { padding: 16px; min-height: 120px; max-height: 260px; overflow-y: auto; font-size: 1em; }
    .chatbot-msg { margin-bottom: 10px; }
    .chatbot-msg.user { text-align: right; color: #2563eb; }
    .chatbot-msg.bot { text-align: left; color: #222; }
    #chatbotInputBar { display: flex; border-top: 1px solid #eee; }
    #chatbotInput { flex: 1; border: none; padding: 12px; font-size: 1em; border-radius: 0 0 0 16px; }
    #chatbotSend { background: #2563eb; color: #fff; border: none; padding: 0 18px; font-size: 1.1em; border-radius: 0 0 16px 0; cursor: pointer; }
    #chatbotSend:hover { background: #1742a0; }
  </style>
  <div id="chatbotWidgetBtn" title="Chat with us!"><i class="fas fa-comment-dots"></i></div>
  <div id="chatbotWidget">
    <div id="chatbotHeader">Ask EdTech Bot <button id="chatbotClose">&times;</button></div>
    <div id="chatbotMessages"></div>
    <form id="chatbotInputBar" autocomplete="off">
      <input id="chatbotInput" type="text" placeholder="Type your question..." required />
      <button id="chatbotSend" type="submit"><i class="fas fa-paper-plane"></i></button>
    </form>
  </div>
  <script>
    // --- Chatbot Widget Logic ---
    const chatbotBtn = document.getElementById('chatbotWidgetBtn');
    const chatbot = document.getElementById('chatbotWidget');
    const chatbotClose = document.getElementById('chatbotClose');
    const chatbotMessages = document.getElementById('chatbotMessages');
    const chatbotInputBar = document.getElementById('chatbotInputBar');
    const chatbotInput = document.getElementById('chatbotInput');
    chatbotBtn.onclick = () => { chatbot.style.display = 'flex'; chatbotInput.focus(); };
    chatbotClose.onclick = () => { chatbot.style.display = 'none'; };
    function addMsg(text, who) {
      const msg = document.createElement('div');
      msg.className = 'chatbot-msg ' + who;
      msg.textContent = text;
      chatbotMessages.appendChild(msg);
      chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }
    // Expanded FAQ and process logic
    function botReply(q) {
      const lower = q.toLowerCase();
      // Booking process
      if (lower.match(/how.*book/)) return 'To book: 1) Select a date and slot. 2) Fill in your details. 3) Confirm. You will get a confirmation email.';
      if (lower.includes('who can book')) return 'Any teacher or staff can book the Discovery Room.';
      if (lower.includes('how many') && lower.includes('slots')) return 'You can book one slot per day. Slots are limited and first-come, first-served.';
      if (lower.includes('change') && lower.includes('booking')) return 'To change a booking, please cancel and rebook, or contact Mr. Albert.';
      if (lower.includes('cancel')) return 'To cancel, reply to your confirmation email or contact Mr. Albert.';
      if (lower.includes('teacher portal')) return 'Teachers can use the Teacher Portal for special access and management.';
      if (lower.includes('waiting list')) return 'If a slot is full, you can join the waiting list. You will be notified if it becomes available.';
      if (lower.includes('email')) return 'You will receive a confirmation email after booking. Check your spam folder if you do not see it.';
      if (lower.includes('location')) return 'The Discovery Room is in Tower A, 2nd Floor, BINUS School Simprug.';
      if (lower.includes('contact')) return 'You can contact Mr. Albert at albert.arthur@binus.edu.';
      if (lower.includes('rules')) return 'Please respect the Discovery Room rules: no food/drink, return items, and keep the space tidy.';
      if (lower.includes('equipment') || lower.includes('tools')) return 'The Discovery Room has VR headsets, robots, Legos, interactive screens, and more!';
      if (lower.includes('faq')) return 'FAQ: 1) How to book? 2) Can I cancel? 3) Where is the room? 4) Who can book? 5) What equipment is available?';
      if (lower.includes('hello') || lower.includes('hi') || lower.includes('hey')) return 'Hello! How can I help you today?';
      return null; // Unknown, trigger fallback
    }

    // Fallback: collect name/email for unknown questions
    let pendingUnknown = false;
    let pendingQuestion = '';
    chatbotInputBar.onsubmit = e => {
      e.preventDefault();
      const q = chatbotInput.value.trim();
      if (!q) return;
      addMsg(q, 'user');
      chatbotInput.value = '';
      if (pendingUnknown === 'name') {
        window._chatbotUserName = q;
        addMsg('Thanks! What is your email address?', 'bot');
        pendingUnknown = 'email';
        return;
      }
      if (pendingUnknown === 'email') {
        window._chatbotUserEmail = q;
        addMsg('Thank you! I will get in touch with Mr. Albert and you will receive a reply via email.', 'bot');
        // Send info to backend to email Mr. Albert
        fetch('/api/chatbot/fallback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: window._chatbotUserName,
            email: window._chatbotUserEmail,
            question: pendingQuestion
          })
        }).then(r => r.json()).then(data => {
          if (data && data.error) {
            addMsg('Sorry, there was a problem sending your question. Please try again later.', 'bot');
          }
        }).catch(() => {
          addMsg('Sorry, there was a problem sending your question. Please try again later.', 'bot');
        });
        pendingUnknown = false;
        pendingQuestion = '';
        return;
      }
      const answer = botReply(q);
      if (answer) {
        setTimeout(() => addMsg(answer, 'bot'), 600);
      } else {
        pendingUnknown = 'name';
        pendingQuestion = q;
        setTimeout(() => addMsg("I'm not sure about that. May I have your name so I can get in touch with Mr. Albert for you?", 'bot'), 600);
      }
    };
  </script>
  <!-- Binus Spirit Values Animation (no dividing line) -->
  <div class="w-full overflow-x-hidden bg-blue-950 py-3 mt-10 mb-2 relative" style="height: 2.5rem;">
    <div id="spiritValuesBar" class="whitespace-nowrap text-yellow-300 text-lg font-bold flex items-center animate-spirit-scroll" style="position: absolute; top: 0; left: 100%; height: 2.5rem; line-height: 2.5rem; background: transparent;">
      <span class="px-8">S - Striving for Excellence</span>
      <span class="px-8">P - Perseverance</span>
      <span class="px-8">I - Integrity</span>
      <span class="px-8">R - Respect</span>
      <span class="px-8">I - Innovation</span>
      <span class="px-8">T - Teamwork</span>
    </div>
    <style>
      @keyframes spirit-scroll {
        0%   { left: 100%; }
        100% { left: -100%; }
      }
      .animate-spirit-scroll {
        animation: spirit-scroll 30s linear infinite;
      }
    </style>
  </div>

  <!-- Discovery Room Items Marquee -->
  <div class="w-full overflow-x-hidden bg-yellow-200 py-3 mb-8 relative" style="height: 2.5rem;">
    <div id="discoveryMarquee" class="whitespace-nowrap text-maroon text-xl font-bold flex items-center animate-discovery-scroll" style="position: absolute; top: 0; left: 100%; height: 2.5rem; line-height: 2.5rem; background: transparent; letter-spacing: 0.5px;">
      <span class="px-8" style="color: #fff;">MetaQuest 3 Headset</span>
      <span class="mx-2 text-2xl" style="color: #FFD700;">|</span>
      <span class="px-8" style="color: #fff;">Active Floor</span>
      <span class="mx-2 text-2xl" style="color: #FFD700;">|</span>
      <span class="px-8" style="color: #fff;">Interactive Screen</span>
      <span class="mx-2 text-2xl" style="color: #FFD700;">|</span>
      <span class="px-8" style="color: #fff;">Legos</span>
      <span class="mx-2 text-2xl" style="color: #FFD700;">|</span>
      <span class="px-8" style="color: #fff;">MBOT2 Advance</span>
      <span class="mx-2 text-2xl" style="color: #FFD700;">|</span>
      <span class="px-8" style="color: #fff;">Botley 2.0</span>
      <span class="mx-2 text-2xl" style="color: #FFD700;">|</span>
      <span class="px-8" style="color: #fff;">MetaQuest 3 Headset</span>
      <span class="mx-2 text-2xl" style="color: #FFD700;">|</span>
      <span class="px-8" style="color: #fff;">Active Floor</span>
      <span class="mx-2 text-2xl" style="color: #FFD700;">|</span>
      <span class="px-8" style="color: #fff;">Interactive Screen</span>
      <span class="mx-2 text-2xl" style="color: #FFD700;">|</span>
      <span class="px-8" style="color: #fff;">Legos</span>
      <span class="mx-2 text-2xl" style="color: #FFD700;">|</span>
      <span class="px-8" style="color: #fff;">MBOT2 Advance</span>
      <span class="mx-2 text-2xl" style="color: #FFD700;">|</span>
      <span class="px-8" style="color: #fff;">Botley 2.0</span>
    </div>
    <style>
      @keyframes discovery-scroll {
        0%   { left: 100%; }
        100% { left: -100%; }
      }
      .animate-discovery-scroll {
        animation: discovery-scroll 40s linear infinite;
      }
    </style>
  </div>

  <!-- Discovery Room Items Gallery -->
  <section class="mb-12">
    <h2 class="text-3xl font-bold text-center text-yellow-200 mb-8">Discovery Room Featured Items</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      <div class="discovery-card bg-white rounded-xl shadow-xl border-2 border-blue-200 p-4 flex flex-col items-center">
        <img src="./images/meta.jpeg" alt="metaQuest 3 Headset" class="h-48 w-auto object-contain mb-4 rounded-lg shadow-md" />
        <div class="text-xl font-semibold text-blue-800 mb-2">MetaQuest 3 Headset</div>
        <div class="text-gray-600 text-center">Immersive VR experiences for learning and creativity.</div>
      </div>
      <div class="discovery-card bg-white rounded-xl shadow-xl border-2 border-blue-200 p-4 flex flex-col items-center">
        <img src="./images/active.jpg" alt="Active Floor" class="h-48 w-auto object-contain mb-4 rounded-lg shadow-md" />
        <div class="text-xl font-semibold text-blue-800 mb-2">Active Floor</div>
        <div class="text-gray-600 text-center">Interactive movement-based learning platform.</div>
      </div>
      <div class="discovery-card bg-white rounded-xl shadow-xl border-2 border-blue-200 p-4 flex flex-col items-center">
        <img src="./images/touch.jpg" alt="Interactive Screen" class="h-48 w-auto object-contain mb-4 rounded-lg shadow-md" />
        <div class="text-xl font-semibold text-blue-800 mb-2">Interactive Screen</div>
        <div class="text-gray-600 text-center">Touch-enabled display for collaborative lessons.</div>
      </div>
      <div class="discovery-card bg-white rounded-xl shadow-xl border-2 border-blue-200 p-4 flex flex-col items-center">
        <img src="./images/legos.jpeg" alt="Legos" class="h-48 w-auto object-contain mb-4 rounded-lg shadow-md" />
        <div class="text-xl font-semibold text-blue-800 mb-2">Legos</div>
        <div class="text-gray-600 text-center">Build, create, and explore with classic and advanced Lego sets.</div>
      </div>
      <div class="discovery-card bg-white rounded-xl shadow-xl border-2 border-blue-200 p-4 flex flex-col items-center">
        <img src="./images/mbot2.jpg" alt="MBOT2 Advance" class="h-48 w-auto object-contain mb-4 rounded-lg shadow-md" />
        <div class="text-xl font-semibold text-blue-800 mb-2">MBOT2 Advance</div>
        <div class="text-gray-600 text-center">Advanced robotics for hands-on STEM learning.</div>
      </div>
      <div class="discovery-card bg-white rounded-xl shadow-xl border-2 border-blue-200 p-4 flex flex-col items-center">
        <img src="./images/botley.jpeg" alt="Botley 2.0" class="h-48 w-auto object-contain mb-4 rounded-lg shadow-md" />
        <div class="text-xl font-semibold text-blue-800 mb-2">Botley 2.0</div>
        <div class="text-gray-600 text-center">Screen-free coding robot for early learners.</div>
      </div>
    </div>
  </section>

  <!-- Footer Quick Links (Simprug only) -->
  <footer class="bg-blue-950 text-yellow-100 py-6 mt-0">
    <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4 px-6">
      <div class="flex flex-col md:flex-row gap-6 items-center">
        <a href="https://school.binus.sch.id/simprug/" target="_blank" class="hover:text-yellow-400 font-semibold">BINUS School Simprug</a>
        <a href="teacher-portal.html" class="hover:text-yellow-400 font-semibold">Teacher Portal</a>
        <a href="mailto:albert.arthur@binus.edu" class="hover:text-yellow-400 font-semibold">Contact Mr. Albert</a>
      </div>
      <div class="flex flex-col items-end md:items-end gap-1">
        <div class="text-xs text-yellow-300">&copy; 2025 BINUS School Simprug EdTech Booking</div>
        <div class="text-xs text-yellow-400 italic">Designed by Albert Arthur</div>
      </div>
    </div>
  </footer>
</body>
</html>
