<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Teacher Booking – Albert Arthur</title>
  <!-- Tailwind & FontAwesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <style>
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    /* Custom scroll for booked slots preview */
    .booked-scroll { max-height: 420px; overflow-y: auto; }
    /* Brand colors */
    .bg-maroon { background-color: #800000; }
    .hover\:bg-maroon-dark:hover { background-color: #660000; }
    .text-maroon { color: #800000; }
    .border-maroon { border-color: #800000; }
    .bg-yellow-brand { background-color: #BFA600; } /* Darker yellow */
    .text-yellow-brand { color: #BFA600; }
    /* Tooltip styles */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 220px;
      background-color: rgba(255,255,255,0.95); /* transparent white */
      color: #1e3a8a; /* dark blue */
      text-align: left;
      border-radius: 6px;
      padding: 8px 12px;
      position: absolute;
      z-index: 10;
      bottom: 120%;
      left: 50%;
      margin-left: -110px;
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 1em;
      pointer-events: none;
      box-shadow: 0 2px 8px rgba(30,58,138,0.08);
      border: 1px solid #dbeafe;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body class="bg-blue-900 min-h-screen">
  <!-- Header Section: Teacher Portal (top left), Logo & Auth (top right), Centered Heading -->
  <div class="container mx-auto px-6 max-w-6xl relative">
    <header class="relative flex flex-col items-center justify-center mb-6" style="min-height:120px;">
      <!-- Teacher Portal Top Left -->
      <div id="teacherPortalBtn" class="absolute top-8 left-0 z-20">
        <a id="teacherPortalLink" href="teacher-portal.html" class="inline-flex items-center px-6 py-3 bg-white text-blue-800 font-semibold rounded-full shadow-lg border-2 border-blue-800 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-200 ml-2 cursor-not-allowed opacity-60" tabindex="-1" aria-disabled="true">
          <i class="fas fa-chalkboard-teacher mr-2"></i>
          Teacher Portal
        </a>
      </div>
      <!-- Logo & Auth Top Right -->
      <div class="absolute top-0 right-0 flex flex-col items-end z-20">
        <img src="./images/simprug.png" alt="BINUS School Logo" class="h-20 w-auto mt-4 mr-2" />
        <div id="authBar" class="flex flex-col items-end gap-2 mt-2 mr-8"></div>
      </div>
      <!-- Centered Heading -->
      <div class="w-full flex flex-col items-center justify-center pt-8">
        <h1 class="text-4xl md:text-5xl font-bold text-yellow-200 drop-shadow mb-1 text-center">Discovery Room Booking</h1>
        <p class="text-yellow-100 text-lg text-center">EdTech Teacher Mr. Albert BINUS School Simprug</p>
      </div>
    </header>
  </div>
  <!-- Sign-Up/Sign-In Modal -->
  <div id="authModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50" style="display:none;">
    <div id="authModalContent" class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full fade-in">
      <h2 class="text-2xl font-bold text-blue-800 mb-4">Welcome! Please Sign Up / Sign In</h2>
      <form id="authForm" class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
          <input type="text" id="authName" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
          <input type="email" id="authEmail" required placeholder="Binusian email here." class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
          <select id="authRole" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
            <option value="">Select role</option>
            <option value="teacher">Teacher</option>
            <option value="staff">Staff</option>
          </select>
        </div>
        <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold shadow hover:bg-blue-700 transition">Sign Up / Sign In</button>
      </form>
    </div>
  </div>
  <div class="container mx-auto px-6 py-8 max-w-6xl relative" id="mainContent">
    <!-- ...existing code... -->

    <!-- Banner -->
    <section class="mb-10">
      <img
        src="./images/Albert_motion.jpg"
        alt="Goofy Banner"
        class="w-full h-72 object-cover rounded-xl shadow-xl border-4 border-yellow-200"
      />
    </section>

    <!-- Booking Calendar -->
    <section class="bg-white rounded-xl shadow-xl p-8 border border-gray-200 mb-12">
      <h2 class="flex items-center text-2xl font-bold text-gray-800 mb-8">
        <i class="fas fa-calendar-alt text-blue-500 mr-3"></i>
        Pick Your Date & Slot
      </h2>
      <!-- Date Range Picker -->
      <div class="flex flex-col md:flex-row gap-6 mb-6">
        <div class="flex-1">
          <label for="bookingDate" class="block text-base font-medium text-gray-700 mb-2">
            Select a date (single)
          </label>
          <input
            type="date"
            id="bookingDate"
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div class="flex-1">
          <label class="block text-base font-medium text-gray-700 mb-2">
            Or pick a date range
          </label>
          <div class="flex gap-3">
            <input
              type="date"
              id="rangeStart"
              class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
            />
            <span class="self-center">to</span>
            <input
              type="date"
              id="rangeEnd"
              class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
            />
          </div>
        </div>
      </div>
      <div class="flex flex-col lg:flex-row gap-10">
        <div class="flex-1">
          <p id="loading" class="text-center text-gray-500 mb-6 hidden">Loading slots…</p>
          <div
            id="slotsContainer"
            class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-2 gap-6"
          ></div>
        </div>
        <!-- Booked Slots Preview -->
        <aside class="w-full lg:w-80 bg-gray-50 border border-gray-200 rounded-xl p-6 booked-scroll">
          <h3 class="text-xl font-bold text-blue-700 mb-4 flex items-center">
            <i class="fas fa-list mr-3"></i>Booked Slots
          </h3>
          <ul id="bookedPreview" class="space-y-3 text-base"></ul>
        </aside>
      </div>
    </section>

    <!-- Gallery -->
    <section class="mb-12">
      <h2 class="text-3xl font-bold text-center text-yellow-200 mb-8">
        Life in Our EdTech Class
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        <img src="./images/Grade1.jpg" alt="Grade 1" class="h-64 w-full object-cover rounded-xl shadow-xl border-2 border-yellow-200" />
        <img src="./images/My_gys.jpg" alt="Fun Activity" class="h-64 w-full object-cover rounded-xl shadow-xl border-2 border-yellow-200" />
        <img src="./images/Space.jpg" alt="Space Learning" class="h-64 w-full object-cover rounded-xl shadow-xl border-2 border-yellow-200" />
        <img src="./images/Girlsclub.jpg" alt="Girls Club" class="h-64 w-full object-cover rounded-xl shadow-xl border-2 border-yellow-200" />
        <img src="./images/Madeit.jpg" alt="Project Success" class="h-64 w-full object-cover rounded-xl shadow-xl border-2 border-yellow-200" />
        <img src="./images/Coding.jpg" alt="Coding Time" class="h-64 w-full object-cover rounded-xl shadow-xl border-2 border-yellow-200" />
      </div>
    </section>
  </div>

  <!-- Booking Modal -->
  <div
    id="bookingModal"
    class="fixed inset-0 hidden flex items-center justify-center bg-black bg-opacity-50 z-50"
  >
    <div class="w-full max-w-md mx-4 bg-white rounded-lg p-6 shadow-lg fade-in">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-gray-800">Confirm Booking</h3>
        <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-lg">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <p class="mb-2 text-gray-600">You're booking:</p>
      <p id="slotInfo" class="mb-4 text-blue-600 font-semibold text-lg"></p>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
        <input
          id="studentName"
          type="text"
          placeholder="Enter your name"
          class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
        />
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Your Class</label>
        <input
          id="studentClass"
          type="text"
          placeholder="Enter your class (e.g. 4A)"
          class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
        />
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Your Email</label>
        <input
          id="studentEmail"
          type="email"
          placeholder="Binusian email here."
          class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
        />
      </div>
      <div class="flex flex-col sm:flex-row sm:justify-end gap-3 mt-4">
        <button
          id="cancelBtn"
          class="flex-1 sm:flex-none px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition"
        >
          Cancel
        </button>
        <button
          id="confirmBtn"
          class="flex-1 sm:flex-none px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition"
        >
          Confirm Booking
        </button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js"></script>

  <!-- Booking Logic -->
  <script type="module">
    // --- Auth Bar Logic ---
    const authBar = document.getElementById("authBar");
    function renderAuthBar() {
      const user = getUser();
      authBar.innerHTML = "";
      const teacherPortalBtn = document.getElementById("teacherPortalBtn");
      const teacherPortalLink = document.getElementById("teacherPortalLink");
      if (user && user.name) {
        // Only enable Teacher Portal if approved
        import("https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js").then(async ({getFirestore, collection, query, where, getDocs}) => {
          const db = getFirestore();
          const usersCol = collection(db, "users");
          const q = query(usersCol, where("email", "==", user.email));
          const snap = await getDocs(q);
          let userDoc = null;
          snap.forEach(doc => userDoc = doc);
          if (userDoc && userDoc.data().approved) {
            teacherPortalLink.classList.remove("cursor-not-allowed", "opacity-60");
            teacherPortalLink.setAttribute("tabindex", "0");
            teacherPortalLink.removeAttribute("aria-disabled");
            teacherPortalLink.onclick = null; // allow navigation
          } else {
            teacherPortalLink.classList.add("cursor-not-allowed", "opacity-60");
            teacherPortalLink.setAttribute("tabindex", "-1");
            teacherPortalLink.setAttribute("aria-disabled", "true");
            teacherPortalLink.onclick = (e) => { e.preventDefault(); };
          }
        });
        // Auth bar only shows user info and logout
        const nameSpan = document.createElement("span");
        nameSpan.className = "text-white font-semibold px-3 py-1 rounded bg-blue-800";
        nameSpan.textContent = `Hello, ${user.name}`;
        const logoutBtn = document.createElement("button");
        logoutBtn.className = "px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition";
        logoutBtn.textContent = "Logout";
        logoutBtn.onclick = () => {
          localStorage.removeItem("edtechUser");
          teacherPortalLink.classList.add("cursor-not-allowed", "opacity-60");
          teacherPortalLink.setAttribute("tabindex", "-1");
          teacherPortalLink.setAttribute("aria-disabled", "true");
          teacherPortalLink.onclick = (e) => { e.preventDefault(); };
          renderAuthBar();
        };
        authBar.appendChild(nameSpan);
        authBar.appendChild(logoutBtn);
      } else {
        // Auth bar only shows main Sign Up / Sign In, never Teacher Portal login
        teacherPortalLink.classList.add("cursor-not-allowed", "opacity-60");
        teacherPortalLink.setAttribute("tabindex", "-1");
        teacherPortalLink.setAttribute("aria-disabled", "true");
        teacherPortalLink.onclick = (e) => { e.preventDefault(); };
        // Horizontal flex container for links
        const linkBar = document.createElement("div");
        linkBar.className = "flex gap-4 mt-2";

        // Login link
        const loginLink = document.createElement("a");
        loginLink.href = "#";
        loginLink.className = "text-blue-400 underline text-base font-semibold hover:text-yellow-200 transition";
        loginLink.textContent = "Login";
        loginLink.onclick = (e) => {
          e.preventDefault();
          showRoleLoginModal("teacher");
        };
        linkBar.appendChild(loginLink);

        // Sign Up link
        const signupLink = document.createElement("a");
        signupLink.href = "#";
        signupLink.className = "text-green-400 underline text-base font-semibold hover:text-yellow-200 transition";
        signupLink.textContent = "Sign Up";
        signupLink.onclick = (e) => {
          e.preventDefault();
          showAuthModal();
        };
        linkBar.appendChild(signupLink);

        authBar.appendChild(linkBar);
        // Ensure Teacher Portal never opens auth modal
        teacherPortalLink.onclick = (e) => { e.preventDefault(); };
    // --- Role Login Modal Logic ---
    function showRoleLoginModal(role) {
      // Remove any existing modal
      let old = document.getElementById("roleLoginModal");
      if (old) old.remove();
      const modal = document.createElement("div");
      modal.id = "roleLoginModal";
      modal.className = "fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50";
      let color = role === "teacher" ? "bg-maroon text-white" : "bg-blue-800 text-white";
      let title = role === "teacher" ? "Teacher Login" : "Staff Login";
      modal.innerHTML = `
        <div class="${color} p-8 rounded-xl shadow-2xl max-w-md w-full fade-in">
          <h2 class="text-2xl font-bold mb-4">${title}</h2>
          <form id="roleLoginForm" class="space-y-6">
            <div>
              <label class="block text-sm font-medium mb-2">Name</label>
              <input type="text" id="roleLoginName" required class="w-full px-4 py-3 border rounded-lg text-black" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Email</label>
              <input type="email" id="roleLoginEmail" required class="w-full px-4 py-3 border rounded-lg text-black" />
            </div>
            <button type="submit" class="w-full px-6 py-3 bg-yellow-500 text-maroon rounded-lg font-semibold shadow hover:bg-yellow-600 transition">Login</button>
          </form>
          <button id="closeRoleLoginBtn" class="mt-6 px-4 py-2 border rounded text-white hover:bg-gray-100 hover:text-black">Close</button>
        </div>
      `;
      document.body.appendChild(modal);
      modal.querySelector("#closeRoleLoginBtn").onclick = () => modal.remove();
      modal.querySelector("#roleLoginForm").onsubmit = async (e) => {
        e.preventDefault();
        const name = modal.querySelector("#roleLoginName").value.trim();
        const email = modal.querySelector("#roleLoginEmail").value.trim().toLowerCase();
        if (!name || !email) {
          alert("All fields are required.");
          return;
        }
        if (!email.endsWith("@binus.edu") && !email.endsWith("@binus.org")) {
          alert("Use your school email (@binus.edu or @binus.org)." );
          return;
        }
        // Check if user exists and approved
        import("https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js").then(async ({getFirestore, collection, query, where, getDocs, addDoc}) => {
          const db = getFirestore();
          const usersCol = collection(db, "users");
          const q = query(usersCol, where("email", "==", email), where("role", "==", role));
          const snap = await getDocs(q);
          let userDoc = null;
          snap.forEach(doc => userDoc = doc);
          if (!userDoc) {
            alert("No account found. Please sign up first.");
            return;
          }
          const userData = userDoc.data();
          if (!userData.approved) {
            alert("Your account is pending approval. Please wait for admin confirmation.");
            return;
          }
          // Approved: log in
          setUser({ name: userData.name, email: userData.email, role: userData.role, id: userDoc.id });
          modal.remove();
          renderAuthBar();
          setTimeout(() => {
            if (!document.getElementById("welcomeMsg")) {
              const msg = document.createElement("div");
              msg.id = "welcomeMsg";
              msg.className = "fixed top-4 right-4 bg-blue-800 text-white px-4 py-2 rounded shadow-lg z-50 fade-in";
              msg.textContent = `Welcome, ${userData.name}!`;
              document.body.appendChild(msg);
              setTimeout(()=>msg.remove(), 3500);
            }
          }, 500);
        });
      };
    }
      }
    }
    renderAuthBar();
    // --- Auth Modal Logic ---
    const authModal = document.getElementById("authModal");
    const authForm = document.getElementById("authForm");
    const authName = document.getElementById("authName");
    const authEmail = document.getElementById("authEmail");
    const authRole = document.getElementById("authRole");
    const mainContent = document.getElementById("mainContent");
    // Booking calendar DOM refs
    const dateInput = document.getElementById("bookingDate");
    const rangeStart = document.getElementById("rangeStart");
    const rangeEnd = document.getElementById("rangeEnd");
    const slotsEl = document.getElementById("slotsContainer");
    const bookedPreview = document.getElementById("bookedPreview");
    const loadingEl = document.getElementById("loading");
    // Modal refs
    const modalEl = document.getElementById("bookingModal");
    const slotInfoEl = document.getElementById("slotInfo");
    const nameInput = document.getElementById("studentName");
    const classInput = document.getElementById("studentClass");
    const emailInput = document.getElementById("studentEmail");
    const closeBtn = document.getElementById("closeModalBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const confirmBtn = document.getElementById("confirmBtn");

    function showAuthModal() {
      authModal.style.display = "flex";
      setTimeout(() => {
        // Add click outside to close
        function outsideClick(e) {
          const modalContent = document.getElementById("authModalContent");
          if (authModal.style.display === "flex" && modalContent && !modalContent.contains(e.target)) {
            hideAuthModal();
            document.removeEventListener("mousedown", outsideClick);
          }
        }
        document.addEventListener("mousedown", outsideClick);
      }, 100);
    }
    function hideAuthModal() {
      authModal.style.display = "none";
    }
    function getUser() {
      try {
        return JSON.parse(localStorage.getItem("edtechUser"));
      } catch { return null; }
    }
    function setUser(user) {
      localStorage.setItem("edtechUser", JSON.stringify(user));
    }
    authForm.onsubmit = function(e) {
      e.preventDefault();
      const name = authName.value.trim();
      const email = authEmail.value.trim().toLowerCase();
      const role = authRole.value;
      if (!name || !email || !role) {
        alert("All fields are required.");
        return;
      }
      if (!email.endsWith("@binus.edu") && !email.endsWith("@binus.org")) {
        alert("Use your school email (@binus.edu or @binus.org)." );
        return;
      }
      // Check if user exists and approved
      import("https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js").then(async ({getFirestore, collection, query, where, getDocs, addDoc}) => {
        const db = getFirestore();
        const usersCol = collection(db, "users");
        const q = query(usersCol, where("email", "==", email));
        const snap = await getDocs(q);
        let userDoc = null;
        snap.forEach(doc => userDoc = doc);
        if (!userDoc) {
          // Register new user as pending approval
          await addDoc(usersCol, {
            name, email, role, approved: false, createdAt: new Date().toISOString()
          });
          alert("Sign-up successful! Await admin approval. You will receive an email when approved.");
          hideAuthModal();
          renderAuthBar();
          return;
        }
        const userData = userDoc.data();
        if (!userData.approved) {
          alert("Your account is pending approval. Please wait for admin confirmation.");
          hideAuthModal();
          renderAuthBar();
          return;
        }
        // Approved: log in
        setUser({ name: userData.name, email: userData.email, role: userData.role, id: userDoc.id });
        hideAuthModal();
        renderAuthBar();
        setTimeout(() => {
          if (!document.getElementById("welcomeMsg")) {
            const msg = document.createElement("div");
            msg.id = "welcomeMsg";
            msg.className = "fixed top-4 right-4 bg-blue-800 text-white px-4 py-2 rounded shadow-lg z-50 fade-in";
            msg.textContent = `Welcome, ${userData.name}!`;
            document.body.appendChild(msg);
            setTimeout(()=>msg.remove(), 3500);
          }
        }, 500);
      });
    };
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, addDoc,
      query, where, connectFirestoreEmulator
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // Firebase config (copy yours)
    const firebaseConfig = {
      apiKey:    "AIzaSyBKhgPEWHqW36Xg0Bx6qwsXq9Hnew0094o",
      authDomain:"school-booking-platform.firebaseapp.com",
      projectId: "school-booking-platform",
      storageBucket: "school-booking-platform.appspot.com",
      messagingSenderId:"673281572597",
      appId:     "1:673281572597:web:fe0ceec0054560f6258fbc",
      measurementId:"G-TVQ5PK5WZF"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    // If you run the emulator locally:
    // connectFirestoreEmulator(db, 'localhost', 8080);

    // Firestore collection
    const bookingsCol = collection(db, "bookings");
    // Add waiting list collection
    const waitingCol = collection(db, "waiting_list");

    // Hard-coded slots by weekday
    const timeSlots = {
      Monday:    ["7:30-7:50","9:10-9:30","11:30-12:10","14:10-15:30"],
      Tuesday:   ["7:30-7:50","9:10-9:30","11:30-12:10"],
      Wednesday: ["7:30-7:50","10:50-12:10"],
      Thursday:  ["7:30-7:50","9:10-9:30","11:30-12:10"],
      Friday:    ["7:30-7:50","10:50-11:30","13:30-14:10"]
    };

    // DOM refs
    // ...existing code...

    let selDate = "", selTime = "";
    let bookedTimes = new Set();
    let bookedDetails = [];

    // Initialize date picker range → today … today+6
    const today = new Date();
    const pad = n => n.toString().padStart(2,"0");
    const iso = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    dateInput.min = iso(today);
    rangeStart.min = iso(today);
    rangeEnd.min = iso(today);
    const maxDate = new Date(today.getTime() + 6*24*60*60*1000);
    dateInput.max = iso(maxDate);
    rangeStart.max = iso(maxDate);
    rangeEnd.max = iso(maxDate);
    dateInput.value = iso(today);

    // Listen for changes
    dateInput.addEventListener("change", ()=>{
      rangeStart.value = "";
      rangeEnd.value = "";
      loadBookings();
    });
    rangeStart.addEventListener("change", ()=>{
      dateInput.value = "";
      if(rangeEnd.value && rangeEnd.value < rangeStart.value) rangeEnd.value = rangeStart.value;
      loadBookings();
    });
    rangeEnd.addEventListener("change", ()=>{
      dateInput.value = "";
      if(rangeStart.value && rangeEnd.value < rangeStart.value) rangeStart.value = rangeEnd.value;
      loadBookings();
    });

    // Helper: get all dates in range
    function getDatesInRange(start, end){
      const dates = [];
      let d = new Date(start);
      const last = new Date(end);
      while(d <= last){
        dates.push(iso(d));
        d.setDate(d.getDate()+1);
      }
      return dates;
    }

    // Load bookings for single date or range
    async function loadBookings(){
      bookedTimes.clear();
      bookedDetails = [];
      slotsEl.innerHTML = "";
      bookedPreview.innerHTML = "";
      let dates = [];
      if(dateInput.value){
        selDate = dateInput.value;
        dates = [selDate];
      } else if(rangeStart.value && rangeEnd.value){
        dates = getDatesInRange(rangeStart.value, rangeEnd.value);
      } else {
        return;
      }
      loadingEl.classList.remove("hidden");
      try {
        // Query all bookings in date(s)
        const q = query(bookingsCol, where("date", ">=", dates[0]), where("date", "<=", dates[dates.length-1]));
        const snap = await getDocs(q);
        snap.forEach(doc => {
          const data = doc.data();
          bookedTimes.add(`${data.date}|${data.time}`);
          bookedDetails.push(data);
        });
        renderSlots(dates);
        renderBookedPreview();
      } catch(e){
        slotsEl.innerHTML = `<p class="text-red-600">Failed to load slots.</p>`;
        console.error(e);
      } finally {
        loadingEl.classList.add("hidden");
      }
    }

    // Helper: format date as DD/MM/YY
    function formatDateDDMMYY(dateStr) {
      const [y, m, d] = dateStr.split("-");
      return `${d}/${m}/${y.slice(2)}`;
    }

    // Render slots for all selected dates
    function renderSlots(dates){
      slotsEl.innerHTML = "";
      dates.forEach(dateStr => {
        const weekday = new Date(dateStr).toLocaleDateString("en-US",{weekday:"long"});
        const times = timeSlots[weekday];
        if(!times) return;
        const col = document.createElement("div");
        col.className = "bg-gray-50 rounded-lg p-4";
        const hdr = document.createElement("h3");
        hdr.textContent = `${weekday} — ${formatDateDDMMYY(dateStr)}`;
        hdr.className = "font-semibold text-lg text-gray-800 mb-3 border-b pb-2";
        col.appendChild(hdr);
        const list = document.createElement("div");
        list.className = "space-y-2";
        times.forEach(time => {
          const bookedKey = `${dateStr}|${time}`;
          const booked = bookedTimes.has(bookedKey);
          let btn;
          if (booked) {
            // Find booking details for tooltip
            const b = bookedDetails.find(bd => bd.date === dateStr && bd.time === time);
            btn = document.createElement("div");
            btn.className = "tooltip";
            const button = document.createElement("button");
            button.textContent = `${time} (Booked)`;
            button.disabled = true;
            button.className = "w-full px-3 py-2 rounded border text-white font-medium bg-red-500 cursor-not-allowed";
            btn.appendChild(button);
            // Tooltip content: transparent white, dark blue, only teacher name and time
            const tip = document.createElement("span");
            tip.className = "tooltiptext";
            tip.innerHTML = b
              ? `<div><span class="font-bold">Teacher:</span> <span>${b.studentName}</span></div>
                 <div><span class="font-bold">Time:</span> <span>${b.time}</span></div>`
              : "";
            btn.appendChild(tip);
          } else {
            btn = document.createElement("button");
            btn.textContent = `${time} (Available)`;
            btn.disabled = false;
            btn.className = "w-full px-3 py-2 rounded border text-white font-medium bg-green-500 hover:bg-green-600";
            btn.onclick = () => openModal(dateStr, time);
          }
          list.appendChild(btn);
        });
        col.appendChild(list);
        slotsEl.appendChild(col);
      });
    }

    // Render vertical preview of booked slots
    function renderBookedPreview(){
      if(!bookedDetails.length){
        bookedPreview.innerHTML = `<li class="text-gray-400">No bookings yet.</li>`;
        return;
      }
      // Sort by date/time
      bookedDetails.sort((a,b)=>{
        if(a.date!==b.date) return a.date.localeCompare(b.date);
        return a.time.localeCompare(b.time);
      });
      bookedPreview.innerHTML = bookedDetails.map(b=>
        `<li class="border-l-4 border-blue-400 pl-2 py-1 bg-white rounded">
          <span class="font-semibold text-blue-800">${formatDateDDMMYY(b.date)}</span>
          <span class="ml-2 text-gray-700">${b.time}</span>
          <div class="text-xs text-gray-500">${b.studentName} (${b.studentClass})</div>
        </li>`
      ).join("");
    }

    // Show the booking modal (now passes date)
    function openModal(date, time){
      const user = getUser();
      if (!user || !user.name || !user.email || !user.role) {
        showAuthModal();
        return;
      }
      // Check approval status before allowing booking
      import("https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js").then(async ({getFirestore, collection, query, where, getDocs}) => {
        const db = getFirestore();
        const usersCol = collection(db, "users");
        const q = query(usersCol, where("email", "==", user.email));
        const snap = await getDocs(q);
        let userDoc = null;
        snap.forEach(doc => userDoc = doc);
        if (!userDoc || !userDoc.data().approved) {
          alert("Your account is not approved yet. Please wait for admin confirmation.");
          return;
        }
        selDate = date;
        selTime = time;
        slotInfoEl.textContent = `${formatDateDDMMYY(selDate)} @ ${selTime}`;
        modalEl.classList.replace("hidden","flex");
      });
    }

    // Hide modal + reset inputs
    function closeModal(){
      modalEl.classList.replace("flex","hidden");
      nameInput.value = "";
      classInput.value = "";
      emailInput.value = "";
    }

    // --- Make cancel and close buttons work ---
    closeBtn.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);

    // Add: Helper to create ICS file content
    function createICS({date, time, name, cls, email}) {
      // Parse time range
      const [startStr, endStr] = time.split("-");
      const [year, month, day] = date.split("-");
      function toICSDate(t) {
        const [h, m] = t.split(":");
        // Pad month/day
        return `${year}${month.padStart(2,"0")}${day.padStart(2,"0")}T${h.padStart(2,"0")}${m}00`;
      }
      const dtStart = toICSDate(startStr);
      const dtEnd = toICSDate(endStr);
      return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//EdTech Booking//EN
BEGIN:VEVENT
UID:${date}-${time}-${email}
DTSTAMP:${dtStart}Z
DTSTART:${dtStart}Z
DTEND:${dtEnd}Z
SUMMARY:Meeting with Mr. Albert
DESCRIPTION:EdTech Booking for ${name} (${cls})\\nEmail: ${email}
LOCATION:BINUS School Simprug
END:VEVENT
END:VCALENDAR`;
    }

    // Confirm & write to Firestore
    confirmBtn.addEventListener("click", async ()=>{
      // Use logged-in user info for booking
      const user = getUser();
      const name  = user?.name || nameInput.value.trim();
      const cls   = classInput.value.trim();
      const email = user?.email || emailInput.value.trim().toLowerCase();

      if(!name||!cls||!email) {
        return alert("All fields are required.");
      }
      if(!email.endsWith("@binus.edu") && !email.endsWith("@binus.org")){
        return alert("Use your school email (@binus.edu or @binus.org).");
      }
      // Double-check duplicate
      if(bookedTimes.has(`${selDate}|${selTime}`)){
        // Slot is booked, offer waiting list
        showWaitingListModal(selDate, selTime, name, cls, email);
        return;
      }
      try {
        await addDoc(bookingsCol, {
          date: selDate,
          time: selTime,
          studentName: name,
          studentClass: cls,
          studentEmail: email,
          status: "confirmed",
          createdAt: new Date().toISOString()
        });
        bookedTimes.add(`${selDate}|${selTime}`);
        bookedDetails.push({
          date: selDate, time: selTime,
          studentName: name, studentClass: cls, status: "confirmed"
        });
        renderSlots(dateInput.value ? [selDate] : getDatesInRange(rangeStart.value, rangeEnd.value));
        renderBookedPreview();
        closeModal();

        // Call email service after booking is confirmed
        try {
          // Use dynamic import for emailService.js
          const { sendBookingConfirmation } = await import('./backend/services/emailService.js');
          sendBookingConfirmation({
            name,
            email,
            date: selDate,
            time: selTime,
            cls
          });
        } catch (err) {
          console.warn("Email service failed:", err);
        }

        // Show invoice/confirmation with Add to Calendar
        showInvoiceOverlay({
          date: selDate, time: selTime,
          name, cls, email
        });
      } catch(e){
        console.error(e);
        alert("Failed to save booking, please try again.");
      }
    });

    // --- Invoice Overlay with Add to Calendar ---
    function showInvoiceOverlay({date, time, name, cls, email}) {
      const overlay = document.createElement("div");
      overlay.className = "fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50";
      const icsContent = createICS({date, time, name, cls, email});
      const icsBlob = new Blob([icsContent], {type: "text/calendar"});
      const icsUrl = URL.createObjectURL(icsBlob);

      overlay.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full fade-in text-center">
          <h2 class="text-2xl font-bold text-green-600 mb-2">Booking Confirmed!</h2>
          <div class="mb-3 text-left">
            <div class="font-semibold text-blue-800">Date:</div>
            <div>${formatDateDDMMYY(date)}</div>
            <div class="font-semibold text-blue-800 mt-2">Time:</div>
            <div>${time}</div>
            <div class="font-semibold text-blue-800 mt-2">Name:</div>
            <div>${name} (${cls})</div>
            <div class="font-semibold text-blue-800 mt-2">Email:</div>
            <div>${email}</div>
          </div>
          <a href="${icsUrl}" download="booking.ics"
            class="inline-block mt-3 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
            >Add to Calendar (Outlook/Google)</a>
          <p class="italic text-yellow-600 mt-4">
            Thanks for booking! If this made you smile, my job here is done. Have a wonderful day and keep being awesome! 😄
          </p>
          <!-- Add to Calendar Buttons -->
          <div class="flex justify-center space-x-4 mt-4">
            <button id="addGoogleCalBtn" class="px-4 py-2 bg-yellow-brand text-maroon rounded hover:bg-yellow-400 transition">
              Add to Google Calendar
            </button>
            <button id="addOutlookCalBtn" class="px-4 py-2 bg-maroon text-white rounded hover:bg-maroon-dark transition">
              Add to Outlook Calendar
            </button>
          </div>
          <button class="mt-6 px-4 py-2 border rounded text-gray-700 hover:bg-gray-100" id="closeInvoiceBtn">Close</button>
        </div>`;
      document.body.appendChild(overlay);
      overlay.querySelector("#closeInvoiceBtn").onclick = () => {
        overlay.remove();
        URL.revokeObjectURL(icsUrl);
      };

      // Add to Calendar handlers
      const encode = encodeURIComponent;
      function getCalTimes(date, time) {
        // date: YYYY-MM-DD, time: "HH:MM-HH:MM"
        const [startStr, endStr] = time.split("-");
        const [year, month, day] = date.split("-");
        function pad(n) { return n.padStart(2, "0"); }
        // Google: YYYYMMDDTHHMMSSZ (UTC), Outlook: ISO
        const start = `${year}${pad(month)}${pad(day)}T${startStr.replace(":","")}00Z`;
        const end   = `${year}${pad(month)}${pad(day)}T${endStr.replace(":","")}00Z`;
        const startISO = `${year}-${pad(month)}-${pad(day)}T${startStr}:00Z`;
        const endISO   = `${year}-${pad(month)}-${pad(day)}T${endStr}:00Z`;
        return { start, end, startISO, endISO };
      }
      const calTitle = "Meeting with Mr. Albert";
      const calDesc = `EdTech Booking for ${name} (${cls})\\nEmail: ${email}`;
      const calLoc = "BINUS School Simprug";
      const { start, end, startISO, endISO } = getCalTimes(date, time);

      overlay.querySelector("#addGoogleCalBtn").onclick = () => {
        const url = `https://calendar.google.com/calendar/render?action=TEMPLATE`
          + `&text=${encode(calTitle)}`
          + `&dates=${start}/${end}`
          + `&details=${encode(calDesc)}`
          + `&location=${encode(calLoc)}`;
        window.open(url, '_blank');
      };
      overlay.querySelector("#addOutlookCalBtn").onclick = () => {
        const url = `https://outlook.live.com/calendar/0/deeplink/compose?path=/calendar/view/Month&rru=addevent`
          + `&startdt=${encode(startISO)}`
          + `&enddt=${encode(endISO)}`
          + `&subject=${encode(calTitle)}`
          + `&body=${encode(calDesc)}`
          + `&location=${encode(calLoc)}`;
        window.open(url, '_blank');
      };
    }

    // --- Waiting List Modal ---
    function showWaitingListModal(date, time, name, cls, email) {
      // Remove any existing modal
      let old = document.getElementById("waitingListModal");
      if (old) old.remove();
      const modal = document.createElement("div");
      modal.id = "waitingListModal";
      modal.className = "fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50";
      modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full fade-in">
          <h3 class="text-xl font-semibold text-gray-800 mb-2">Slot Already Booked</h3>
          <p class="mb-2 text-gray-600">Would you like to join the waiting list for:</p>
          <div class="mb-2 text-maroon font-semibold">${formatDateDDMMYY(date)} @ ${time}</div>
          <form id="waitingForm" class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
              <input type="text" id="waitName" value="${name||""}" required
                class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Your Class</label>
              <input type="text" id="waitClass" value="${cls||""}" required
                class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Your Email</label>
              <input type="email" id="waitEmail" value="${email||""}" required
                placeholder="Binusian email here."
                class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500" />
            </div>
            <div class="flex flex-col sm:flex-row sm:justify-end gap-3 mt-4">
              <button type="button" id="cancelWaitBtn"
                class="flex-1 sm:flex-none px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition"
              >Cancel</button>
              <button type="submit"
                class="flex-1 sm:flex-none px-4 py-2 bg-maroon text-white rounded hover:bg-maroon-dark transition"
              >Join Waiting List</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      modal.querySelector("#cancelWaitBtn").onclick = () => modal.remove();
      modal.querySelector("#waitingForm").onsubmit = async (e) => {
        e.preventDefault();
        const waitName = modal.querySelector("#waitName").value.trim();
        const waitClass = modal.querySelector("#waitClass").value.trim();
        const waitEmail = modal.querySelector("#waitEmail").value.trim().toLowerCase();
        if(!waitName||!waitClass||!waitEmail){
          alert("All fields are required.");
          return;
        }
        if(!waitEmail.endsWith("@binus.edu") && !waitEmail.endsWith("@binus.org")){
          alert("Use your school email (@binus.edu or @binus.org).");
          return;
        }
        try {
          await addDoc(waitingCol, {
            date, time,
            studentName: waitName,
            studentClass: waitClass,
            studentEmail: waitEmail,
            createdAt: new Date().toISOString()
          });
          modal.remove();
          showWaitingListConfirmation({date, time, waitName, waitClass, waitEmail});
        } catch(e){
          alert("Failed to join waiting list, please try again.");
        }
      };
    }

    // --- Waiting List Confirmation Overlay ---
    function showWaitingListConfirmation({date, time, waitName, waitClass, waitEmail}) {
      const overlay = document.createElement("div");
      overlay.className = "fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50";
      // Fetch queue position
      import("https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js").then(async ({getFirestore, collection, query, where, getDocs}) => {
        const db = getFirestore();
        const waitingCol = collection(db, "waiting_list");
        const q = query(waitingCol, where("date", "==", date), where("time", "==", time));
        const snap = await getDocs(q);
        let queueNum = 1;
        let found = false;
        snap.forEach(doc => {
          const d = doc.data();
          if (d.studentEmail === waitEmail) found = true;
          if (!found) queueNum++;
        });
        overlay.innerHTML = `
          <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full fade-in text-center">
            <h2 class="text-2xl font-bold text-blue-600 mb-2">Added to Waiting List!</h2>
            <div class="mb-3 text-left">
              <div class="font-semibold text-blue-800">Date:</div>
              <div>${formatDateDDMMYY(date)}</div>
              <div class="font-semibold text-blue-800 mt-2">Time:</div>
              <div>${time}</div>
              <div class="font-semibold text-blue-800 mt-2">Name:</div>
              <div>${waitName} (${waitClass})</div>
              <div class="font-semibold text-blue-800 mt-2">Email:</div>
              <div>${waitEmail}</div>
              <div class="font-semibold text-green-700 mt-2">Your Queue Number:</div>
              <div class="text-green-700 text-xl font-bold">${queueNum}</div>
            </div>
            <p class="italic text-yellow-600 mt-4">
              We'll notify you if this slot becomes available!
            </p>
            <button class="mt-6 px-4 py-2 border rounded text-gray-700 hover:bg-gray-100" id="closeWaitBtn">Close</button>
          </div>`;
        document.body.appendChild(overlay);
        overlay.querySelector("#closeWaitBtn").onclick = () => overlay.remove();
      });
    }

    // Kick things off
    loadBookings();
  </script>
  <!-- Binus Spirit Values Animation (no dividing line) -->
  <div class="w-full overflow-hidden bg-blue-950 py-3 mt-10 mb-2 relative">
    <div id="spiritValuesBar" class="absolute whitespace-nowrap text-yellow-300 text-lg font-bold flex items-center animate-spirit-scroll" style="will-change: transform; left:100%;">
      <span class="px-8">S - Striving for Excellence</span>
      <span class="px-8">P - Perseverance</span>
      <span class="px-8">I - Integrity</span>
      <span class="px-8">R - Respect</span>
      <span class="px-8">I - Innovation</span>
      <span class="px-8">T - Teamwork</span>
    </div>
    <style>
      @keyframes spirit-scroll {
        0%   { left: 100%; }
        100% { left: -100%; }
      }
      .animate-spirit-scroll {
        animation: spirit-scroll 30s linear infinite;
      }
    </style>
  </div>

  <!-- Footer Quick Links (Simprug only) -->
  <footer class="bg-blue-950 text-yellow-100 py-6 mt-0">
    <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4 px-6">
      <div class="flex flex-col md:flex-row gap-6 items-center">
        <a href="https://school.binus.sch.id/simprug/" target="_blank" class="hover:text-yellow-400 font-semibold">BINUS School Simprug</a>
        <a href="teacher-portal.html" class="hover:text-yellow-400 font-semibold">Teacher Portal</a>
        <a href="mailto:albert.arthur@binus.edu" class="hover:text-yellow-400 font-semibold">Contact Mr. Albert</a>
      </div>
      <div class="text-xs text-yellow-300 mt-2 md:mt-0">&copy; 2025 BINUS School Simprug EdTech Booking</div>
    </div>
  </footer>
</body>
</html>
